name: Docker Compose Orchestration Test

on:
  push:
    branches: [ '**' ]
    paths:
      - 'tts/Docker/**'
      - 'auth/**'
      - 'tts/workflow_api/**'
      - 'tts/messaging/**'
      - 'tts/notification_service/**'
      - 'tts/frontend/**'
      - '.github/workflows/docker-compose-test.yml'
  pull_request:
    branches: [ '**' ]
  workflow_dispatch:

env:
  COMPOSE_FILE: docker-compose.yml
  STARTUP_TIMEOUT: 120

jobs:
  build-containers:
    name: Build All Docker Containers
    runs-on: ubuntu-latest
    outputs:
      build-status: ${{ steps.build.outcome }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build all services (no cache)
        id: build
        working-directory: tts/Docker
        run: |
          echo "Building all Docker services..."
          docker compose build --no-cache 2>&1 | tee build.log
          
          if [ $? -eq 0 ]; then
            echo "✅ All containers built successfully"
            echo "build_success=true" >> $GITHUB_OUTPUT
          else
            echo "❌ Container build failed"
            echo "build_success=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Verify Docker images created
        run: |
          echo "=== Docker Images Created ==="
          docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}" | grep -E "docker-|rabbitmq|postgres" || true
          
          # Check each expected image
          expected_images=("docker-auth-service" "docker-workflow-api" "docker-workflow-worker" "docker-messaging-service" "docker-notification-service" "docker-notification-worker")
          
          missing_images=()
          for img in "${expected_images[@]}"; do
            if ! docker images --format "{{.Repository}}" | grep -q "$img"; then
              missing_images+=("$img")
            fi
          done
          
          if [ ${#missing_images[@]} -gt 0 ]; then
            echo "⚠️ Some images may not have built (could be named differently):"
            printf '%s\n' "${missing_images[@]}"
          else
            echo "✅ All expected images found"
          fi

      - name: Upload build logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: tts/Docker/build.log
          retention-days: 7

  orchestration-test:
    name: Test Docker Compose Orchestration
    runs-on: ubuntu-latest
    needs: build-containers
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker images
        working-directory: tts/Docker
        run: docker compose build

      - name: Start all services
        working-directory: tts/Docker
        run: |
          echo "Starting Docker Compose services..."
          docker compose up -d
          
          echo "Waiting for services to initialize (${STARTUP_TIMEOUT}s max)..."
          sleep 60

      - name: Debug - Show actual container names
        run: |
          echo "=== Container Discovery ==="
          echo "All containers (running and stopped):"
          docker ps -a --format "table {{.Names}}\t{{.Image}}\t{{.Status}}\t{{.Ports}}"
          echo ""
          echo "Docker Compose service status:"
          cd tts/Docker && docker compose ps -a
          echo ""
          echo "RabbitMQ containers:"
          docker ps -a --filter "name=rabbitmq" --format "table {{.Names}}\t{{.Status}}"
          echo ""
          echo "Database containers:"
          docker ps -a --filter "name=db" --format "table {{.Names}}\t{{.Status}}"

      - name: Wait for services to be healthy
        working-directory: tts/Docker
        run: |
          echo "Waiting for Docker Compose services to be healthy..."
          max_attempts=24  # 2 minutes total (5s * 24)
          attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            echo "Health check attempt $attempt/$max_attempts"
            
            # Check if all services are healthy or running
            unhealthy_services=$(docker compose ps --format json | jq -r '.[] | select(.Health != "healthy" and .State != "running") | .Service' 2>/dev/null || echo "")
            
            if [ -z "$unhealthy_services" ]; then
              echo "✅ All services appear to be healthy/running"
              break
            fi
            
            echo "⏳ Waiting for services to be healthy: $unhealthy_services"
            docker compose ps
            sleep 5
            attempt=$((attempt + 1))
          done
          
          if [ $attempt -gt $max_attempts ]; then
            echo "⚠️ Some services may not be fully healthy, but continuing..."
            docker compose ps
          fi

      - name: Check container status
        id: container_status
        run: |
          echo "=== Container Status ==="
          docker ps -a --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          
          # Count running containers
          running=$(docker ps --filter "status=running" --format "{{.Names}}" | wc -l)
          total=$(docker ps -a --format "{{.Names}}" | wc -l)
          
          echo ""
          echo "Running: $running / Total: $total"
          
          # Check for crashed containers
          crashed=$(docker ps -a --filter "status=exited" --format "{{.Names}}: {{.Status}}")
          if [ -n "$crashed" ]; then
            echo ""
            echo "⚠️ Exited containers:"
            echo "$crashed"
          fi

      - name: Verify RabbitMQ is healthy
        working-directory: tts/Docker
        run: |
          echo "Checking RabbitMQ health..."
          max_attempts=10
          attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            # Use docker compose exec to check RabbitMQ health
            if docker compose exec -T rabbitmq rabbitmq-diagnostics -q ping 2>/dev/null; then
              echo "✅ RabbitMQ is healthy"
              break
            fi
            echo "Attempt $attempt/$max_attempts - RabbitMQ not ready yet..."
            sleep 5
            attempt=$((attempt + 1))
          done
          
          if [ $attempt -gt $max_attempts ]; then
            echo "❌ RabbitMQ failed to become healthy"
            echo "RabbitMQ container status:"
            docker compose ps rabbitmq
            echo "RabbitMQ logs:"
            docker compose logs rabbitmq | tail -30
            exit 1
          fi

      - name: Verify PostgreSQL is ready
        working-directory: tts/Docker
        run: |
          echo "Checking PostgreSQL..."
          max_attempts=10
          attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            # Use docker compose exec to check PostgreSQL readiness
            if docker compose exec -T db pg_isready -U postgres 2>/dev/null; then
              echo "✅ PostgreSQL is ready"
              break
            fi
            echo "Attempt $attempt/$max_attempts - PostgreSQL not ready yet..."
            sleep 5
            attempt=$((attempt + 1))
          done
          
          if [ $attempt -gt $max_attempts ]; then
            echo "❌ PostgreSQL failed to become ready"
            echo "PostgreSQL container status:"
            docker compose ps db
            echo "PostgreSQL logs:"
            docker compose logs db | tail -30
            exit 1
          fi

      - name: Verify databases are created
        working-directory: tts/Docker
        run: |
          echo "Checking databases in PostgreSQL..."
          docker compose exec -T db psql -U postgres -c "\l" | grep -E "workflowmanagement|notificationservice" || echo "Some databases may not be created yet"

      - name: Wait for services to fully initialize
        run: |
          echo "Waiting additional time for Django services to start..."
          sleep 30

      - name: Test Auth Service
        continue-on-error: true
        run: |
          echo "Testing Auth Service (port 8003)..."
          response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8003/api/ 2>/dev/null || echo "000")
          
          if [ "$response" = "000" ]; then
            echo "⚠️ Auth Service not responding (may still be starting)"
          elif [ "$response" -ge 200 ] && [ "$response" -lt 500 ]; then
            echo "✅ Auth Service responding (HTTP $response)"
          else
            echo "⚠️ Auth Service returned HTTP $response"
          fi

      - name: Test Workflow API Service
        continue-on-error: true
        run: |
          echo "Testing Workflow API (port 8002)..."
          response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8002/api/ 2>/dev/null || echo "000")
          
          if [ "$response" = "000" ]; then
            echo "⚠️ Workflow API not responding (may still be starting)"
          elif [ "$response" -ge 200 ] && [ "$response" -lt 500 ]; then
            echo "✅ Workflow API responding (HTTP $response)"
          else
            echo "⚠️ Workflow API returned HTTP $response"
          fi

      - name: Test Messaging Service
        continue-on-error: true
        run: |
          echo "Testing Messaging Service (port 8005)..."
          response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8005/ 2>/dev/null || echo "000")
          
          if [ "$response" = "000" ]; then
            echo "⚠️ Messaging Service not responding (may still be starting)"
          elif [ "$response" -ge 200 ] && [ "$response" -lt 500 ]; then
            echo "✅ Messaging Service responding (HTTP $response)"
          else
            echo "⚠️ Messaging Service returned HTTP $response"
          fi

      - name: Test Notification Service
        continue-on-error: true
        run: |
          echo "Testing Notification Service (port 8006)..."
          response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8006/ 2>/dev/null || echo "000")
          
          if [ "$response" = "000" ]; then
            echo "⚠️ Notification Service not responding (may still be starting)"
          elif [ "$response" -ge 200 ] && [ "$response" -lt 500 ]; then
            echo "✅ Notification Service responding (HTTP $response)"
          else
            echo "⚠️ Notification Service returned HTTP $response"
          fi

      - name: Verify Celery workers are running
        run: |
          echo "=== Celery Worker Status ==="
          
          # Check workflow worker
          if docker ps --filter "name=workflow-worker" --filter "status=running" | grep -q workflow-worker; then
            echo "✅ Workflow Worker is running"
          else
            echo "⚠️ Workflow Worker may not be running"
          fi
          
          # Check notification worker
          if docker ps --filter "name=notification-worker" --filter "status=running" | grep -q notification-worker; then
            echo "✅ Notification Worker is running"
          else
            echo "⚠️ Notification Worker may not be running"
          fi

      - name: Check RabbitMQ queues
        continue-on-error: true
        working-directory: tts/Docker
        run: |
          echo "=== RabbitMQ Queue Status ==="
          docker compose exec -T rabbitmq rabbitmqctl list_queues name messages consumers 2>/dev/null || echo "Could not list queues"

      - name: Collect service logs on failure
        if: failure()
        working-directory: tts/Docker
        run: |
          mkdir -p ../../logs
          
          echo "=== Docker Compose Services Status ===" >> ../../logs/all-services.log
          docker compose ps >> ../../logs/all-services.log
          echo "" >> ../../logs/all-services.log
          
          # Get logs from all services using docker compose
          echo "=== All Services Logs ===" >> ../../logs/all-services.log
          docker compose logs >> ../../logs/all-services.log 2>&1 || echo "Failed to collect compose logs" >> ../../logs/all-services.log

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: service-logs
          path: logs/
          retention-days: 7

      - name: Final service status
        if: always()
        run: |
          echo ""
          echo "=== Final Container Status ==="
          docker ps -a --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

      - name: Stop all services
        if: always()
        working-directory: tts/Docker
        run: |
          echo "Stopping all services..."
          docker compose down -v
          echo "✅ Services stopped and volumes removed"

  service-logs-review:
    name: Review Service Logs
    runs-on: ubuntu-latest
    needs: build-containers
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and start services briefly
        working-directory: tts/Docker
        run: |
          docker compose build
          docker compose up -d
          sleep 45

      - name: Collect startup logs
        working-directory: tts/Docker
        run: |
          echo "=== Docker Compose Services Status ==="
          docker compose ps
          echo ""
          echo "=== All Services Startup Logs ==="
          docker compose logs | head -200

      - name: Check for startup errors
        working-directory: tts/Docker
        run: |
          echo "=== Checking for errors in logs ==="
          
          # Get logs from all services and check for errors
          compose_logs=$(docker compose logs 2>&1)
          errors=$(echo "$compose_logs" | grep -iE "error|exception|failed|traceback" | head -20 || true)
          
          if [ -n "$errors" ]; then
            echo "⚠️ Potential issues found in logs:"
            echo "$errors"
          else
            echo "✅ No obvious errors found in startup logs"
          fi

      - name: Stop services
        if: always()
        working-directory: tts/Docker
        run: docker compose down -v

  test-summary:
    name: Orchestration Test Summary
    runs-on: ubuntu-latest
    needs: [build-containers, orchestration-test, service-logs-review]
    if: always()
    steps:
      - name: Summary
        run: |
          echo "=============================================="
          echo "  Docker Compose Orchestration Test Summary  "
          echo "=============================================="
          echo ""
          echo "Build Containers:     ${{ needs.build-containers.result }}"
          echo "Orchestration Test:   ${{ needs.orchestration-test.result }}"
          echo "Service Logs Review:  ${{ needs.service-logs-review.result }}"
          echo ""
          
          if [ "${{ needs.build-containers.result }}" = "success" ] && \
             [ "${{ needs.orchestration-test.result }}" = "success" ]; then
            echo "✅ Docker Compose orchestration is working!"
          else
            echo "⚠️ Some tests did not pass - check individual job results"
          fi

      - name: Set final status
        run: |
          if [ "${{ needs.build-containers.result }}" = "failure" ]; then
            echo "❌ Build failed"
            exit 1
          fi
          
          if [ "${{ needs.orchestration-test.result }}" = "failure" ]; then
            echo "❌ Orchestration test failed"
            exit 1
          fi
          
          echo "✅ All critical tests passed"
