version: '3.9'

services:
  # --- Authentication Service (Using Centralized Root Auth) ---
  auth_db:
    image: postgres:15-alpine
    container_name: auth_db
    volumes:
      - postgres_auth_data:/var/lib/postgresql/data/
    environment:
      - POSTGRES_DB=budgetpro_auth
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=a4d
    ports:
      - "5433:5432"
    networks:
      - my_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  auth_service:
    # 1. Point to the ROOT auth folder
    build: ../auth  
    container_name: auth_service
    volumes:
      - ../auth:/app
    ports:
      - "8001:8000"
    
    # 2. OVERRIDE the entrypoint script.
    # This runs the setup logic manually, bypassing Windows file issues.
    command: >
      sh -c "python manage.py makemigrations --noinput &&
             python manage.py migrate --noinput &&
             python manage.py create_default_admin &&
             python manage.py seed_systems &&
             python manage.py seed_tts &&
             python manage.py seed_hdts &&
             python manage.py seed_bms && 
             gunicorn auth.wsgi:application --bind 0.0.0.0:8000"
             
    environment:
      - RECAPTCHA_ENABLED=False
      - DJANGO_ENV=development
      - DJANGO_SECRET_KEY=g^-i4u72k#@x1xmf4r@$%afoft=xsati0&8o9v5sa(s-#_wz++
      - DJANGO_DEBUG=True
      # Database Config
      - POSTGRES_DB=budgetpro_auth
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=a4d
      - PGHOST=auth_db
      - PGPORT=5432
      # CORS: Allow your BMS Frontend (5173) to talk to Auth
      - DJANGO_CORS_ALLOWED_ORIGINS=http://localhost:5173,http://127.0.0.1:5173
      - DJANGO_CSRF_TRUSTED_ORIGINS=http://localhost:5173,http://127.0.0.1:5173
      - FRONTEND_URL=http://localhost:5173
    depends_on:
      auth_db:
        condition: service_healthy
    networks:
      - my_network

  budget_db:
    # Keep existing configuration)
    image: postgres:15-alpine
    container_name: budget_db
    volumes:
      - postgres_budget_data:/var/lib/postgresql/data/
    environment:
      - POSTGRES_DB=budgetpro_db
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=a4d
    ports:
      - "5434:5432"
    networks:
      - my_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  budget_service:
    # (Keep existing configuration)
    build: ./budget_service
    container_name: budget_service
    volumes:
      - ./budget_service:/app
    ports:
      - "8000:8000"
    environment:
      - DJANGO_CORS_ALLOWED_ORIGINS=http://localhost:5173,http://127.0.0.1:5173
      - DJANGO_CSRF_TRUSTED_ORIGINS=http://localhost:5173,http://127.0.0.1:5173
    env_file:
      - ./budget_service/.env.docker
    depends_on:
      budget_db:
        condition: service_healthy
      auth_service:
        condition: service_started
    networks:
      - my_network

networks:
  my_network:
    driver: bridge

volumes:
  postgres_auth_data:
  postgres_budget_data: