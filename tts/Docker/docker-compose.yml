# add pgadmin somewhere
# docker-compose build
# docker-compose up -d
# lessen the postgresql to one, provision multiple dbs in the same instance
# none of the following env's would be used if there is already an .env file in the respective service directory

services:
  # Kong API Gateway
  kong:
    image: kong:3.4
    restart: unless-stopped
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: /kong/kong.docker.yml
      KONG_PROXY_ACCESS_LOG: /dev/stdout
      KONG_ADMIN_ACCESS_LOG: /dev/stdout
      KONG_PROXY_ERROR_LOG: /dev/stderr
      KONG_ADMIN_ERROR_LOG: /dev/stderr
      KONG_ADMIN_LISTEN: "0.0.0.0:8001"
      KONG_PROXY_LISTEN: "0.0.0.0:8000"
    ports:
      - "8080:8000"   # Kong proxy (main API gateway)
      - "8001:8001"   # Kong admin API
    volumes:
      - ./kong.docker.yml:/kong/kong.docker.yml:ro
    depends_on:
      - auth-service
      - workflow-api
      - notification-service
      - messaging-service
      - helpdesk-service
    healthcheck:
      test: ["CMD", "kong", "health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  # RabbitMQ for message queueing - No sleep
  rabbitmq:
    image: rabbitmq:3.13-management-alpine
    restart: unless-stopped
    ports:
      - "5672:5672"       # AMQP protocol
      - "15672:15672"     # Management UI
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: admin
      RABBITMQ_DEFAULT_VHOST: /
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # Mailpit for email testing
  mailpit:
    image: axllent/mailpit
    restart: always
    ports:
      - "8025:8025"
      - "1025:1025"

  # Single PostgreSQL database instance - No sleep
  db:
    image: postgres:15
    restart: unless-stopped
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgrespass
      POSTGRES_DB: postgres
    ports:
      - "5433:5432"  # Changed the host port to 5433
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./db-init:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # Worker derived from workflow-api - 20 seconds sleep
  workflow-worker:
    build:
      context: ../workflow_api
      dockerfile: Dockerfile
    environment:
      DJANGO_ENV: "production"
      DJANGO_DEBUG: "False"
      DJANGO_SECRET_KEY: "secret-key-1234"
      DJANGO_JWT_SIGNING_KEY: "signing-key-1234"
      DJANGO_ALLOWED_HOSTS: "165.22.247.50,127.0.0.1,workflow-worker"
      KONG_TRUSTED: "true"
      DATABASE_URL: "postgres://postgres:postgrespass@db:5432/workflowmanagement"
      PGHOST: "db"
      PGPORT: "5432"
      POSTGRES_DB: "workflow_db"
      POSTGRES_USER: "postgres"
      POSTGRES_PASSWORD: "postgrespass"
      DJANGO_CELERY_BROKER_URL: "amqp://admin:admin@rabbitmq:5672/"
      DJANGO_NOTIFICATION_SERVICE_BROKER_URL: "amqp://admin:admin@rabbitmq:5672/"
      DJANGO_AUTH_SERVICE_URL: "http://auth-service:8000"
      DJANGO_NOTIFICATION_SERVICE_URL: "http://notification-service:8001"
      C_FORCE_ROOT: "false"
    volumes:
      - media_files:/app/media
    command: >
      sh -c "sleep 20 && 
             celery -A workflow_api worker --pool=solo --loglevel=info -Q role_send-default,TICKET_TASKS_PRODUCTION,tts.role.sync,tts.user_system_role.sync,workflow_seed_queue,workflow_seed"
    depends_on:
      rabbitmq:
        condition: service_healthy
      db:
        condition: service_started

  # Helpdesk service - 10 seconds sleep
  helpdesk-service:
    build:
      context: ../../hdts/helpdesk
      dockerfile: Dockerfile
    environment:
      DJANGO_ENV: "development"
      DJANGO_DEBUG: "True"
      DJANGO_SECRET_KEY: "secret-key-1234"
      DJANGO_ALLOWED_HOSTS: "165.22.247.50,127.0.0.1,helpdesk-service,host.docker.internal"
      KONG_TRUSTED: "true"
      DJANGO_CORS_ALLOWED_ORIGINS: "http://165.22.247.50:1000,http://127.0.0.1:1000,http://165.22.247.50:8080,http://165.22.247.50:5173,http://127.0.0.1:5173"
      DJANGO_CORS_ALLOW_ALL_ORIGINS: "False"
      # DATABASE_URL: "postgres://postgres:postgrespass@db:5432/helpdesk"
      # PGHOST: "db"
      # PGPORT: "5432"
      # POSTGRES_DB: "helpdesk"
      # POSTGRES_USER: "postgres"
      # POSTGRES_PASSWORD: "postgrespass"
      CELERY_BROKER_URL: "amqp://admin:admin@rabbitmq:5672/"
      CELERY_TASK_DEFAULT_QUEUE: "TICKET_TASKS_PRODUCTION"
      DJANGO_SUPERUSER_EMAIL: "admin@helpdesk.com"
      DJANGO_SUPERUSER_USERNAME: "admin"
      DJANGO_SUPERUSER_PASSWORD: "admin123"
    ports:
      - "5001:8000"
    volumes:
      - media_files:/app/media
    depends_on:
      rabbitmq:
        condition: service_healthy
      db:
        condition: service_healthy
      auth-service:
        condition: service_started
    command: sh -c "sleep 30 && ./start.sh"

  # Helpdesk worker - Added from ecosystem config
  helpdesk-worker:
    build:
      context: ../../hdts/helpdesk
      dockerfile: Dockerfile
    environment:
      DJANGO_ENV: "development"
      DJANGO_DEBUG: "True"
      DJANGO_SECRET_KEY: "secret-key-1234"
      DJANGO_JWT_SIGNING_KEY: "signing-key-1234"
      KONG_TRUSTED: "true"
      CELERY_BROKER_URL: "amqp://admin:admin@rabbitmq:5672/"
    depends_on:
      rabbitmq:
        condition: service_healthy
      db:
        condition: service_started
    command: >
      sh -c "sleep 15 && 
             celery -A backend worker --loglevel=info --queues=hdts.user.sync,hdts.user_system_role.sync,hdts.employee.sync,ticket_tasks2 --pool=solo"

  # Workflow API service - 10 seconds sleep
  workflow-api:
    build:
      context: ../workflow_api
      dockerfile: Dockerfile
    environment:
      DJANGO_ENV: "production"
      DJANGO_DEBUG: "False"
      DJANGO_SECRET_KEY: "secret-key-1234"
      DJANGO_JWT_SIGNING_KEY: "signing-key-1234"
      DJANGO_ALLOWED_HOSTS: "165.22.247.50,127.0.0.1,workflow-api,host.docker.internal"
      KONG_TRUSTED: "true"
      DATABASE_URL: "postgres://postgres:postgrespass@db:5432/workflowmanagement"
      PGHOST: "db"
      PGPORT: "5432"
      POSTGRES_DB: "workflow_db"
      POSTGRES_USER: "postgres"
      POSTGRES_PASSWORD: "postgrespass"
      DJANGO_CORS_ALLOWED_ORIGINS: "http://165.22.247.50:1000,http://127.0.0.1:1000,http://165.22.247.50:8080,http://165.22.247.50:5173,http://127.0.0.1:5173,http://165.22.247.50:3000,http://127.0.0.1:3000"
      DJANGO_CELERY_BROKER_URL: "amqp://admin:admin@rabbitmq:5672/"
      DJANGO_NOTIFICATION_SERVICE_BROKER_URL: "amqp://admin:admin@rabbitmq:5672/"
      DJANGO_NOTIFICATION_QUEUE: "notification-queue-default"
      DJANGO_TICKET_STATUS_QUEUE: "ticket_status-default"
      DJANGO_INAPP_NOTIFICATION_QUEUE: "inapp-notification-queue"
      DJANGO_AUTH_SERVICE_URL: "http://auth-service:8000"
      DJANGO_NOTIFICATION_SERVICE_URL: "http://notification-service:8001"
      DJANGO_TTS_SERVICE_URL: "http://workflow-api:8000"
      DJANGO_HELPDESK_SERVICE_URL: "http://helpdesk-service:8000"
      DJANGO_USER_SERVICE_URL: "http://165.22.247.50:3000"
      DJANGO_BASE_URL: "http://165.22.247.50:1001"
      DJANGO_FRONTEND_URL: "http://165.22.247.50:1000/register"
    ports:
      - "1001:8000"
    depends_on:
      rabbitmq:
        condition: service_healthy
      db:
        condition: service_started
    command: sh -c "sleep 10 && ./start.sh"

  # Auth service - 10 seconds sleep
  auth-service:
    build:
      context: ../../auth
      dockerfile: Dockerfile
    env_file:
      - .env
    environment:
      DJANGO_ENV: "development"
      DJANGO_DEBUG: "True"
      DJANGO_SECRET_KEY: "signing-key-1234"
      DJANGO_JWT_SIGNING_KEY: "signing-key-1234"
      DJANGO_ALLOWED_HOSTS: "165.22.247.50,165.22.247.50:3001,165.22.247.50:8003,127.0.0.1,localhost,auth-service,host.docker.internal"
      KONG_TRUSTED: "true"
      RECAPTCHA_ENABLED: "False"
      FRONTEND_URL: "http://165.22.247.50:3001"
      PUBLIC_BASE_URL: "http://165.22.247.50:8080"
      COOKIE_DOMAIN: "165.22.247.50"
      DJANGO_SESSION_COOKIE_SECURE: "False"
      DJANGO_SESSION_COOKIE_SAMESITE: "Lax"
      DJANGO_SESSION_COOKIE_HTTPONLY: "True"
      DJANGO_CSRF_COOKIE_SECURE: "False"
      DJANGO_CSRF_COOKIE_SAMESITE: "Lax"
      DJANGO_CORS_ALLOWED_ORIGINS: "http://165.22.247.50:1000,http://127.0.0.1:1000,http://165.22.247.50:8080,http://165.22.247.50:3001,http://127.0.0.1:3001,http://165.22.247.50:5173,http://127.0.0.1:5173"
      DJANGO_CSRF_TRUSTED_ORIGINS: "http://165.22.247.50:8080,http://165.22.247.50:3001,http://127.0.0.1:3001,http://165.22.247.50:3000,http://127.0.0.1:3000"
      TTS_SYSTEM_URL: "http://165.22.247.50:1000/"
      AMS_SYSTEM_URL: "http://165.22.247.50:3000/ams"
      HDTS_SYSTEM_URL: "http://165.22.247.50:5173/hdts"
      BMS_SYSTEM_URL: "http://165.22.247.50:3000/bms"
      DEFAULT_SYSTEM_URL: "http://165.22.247.50:3000/dashboard"
      CELERY_BROKER_URL: "amqp://admin:admin@rabbitmq:5672/"
      SENDGRID_API_KEY: "${SENDGRID_API_KEY}"
      SENDGRID_FROM_EMAIL: "security@noreply.mapactive.tech"
      SENDGRID_FROM_NAME: "MapActive"
      SENDGRID_ENABLED: "True"
      SUPPORT_EMAIL: "support@mapactive.tech"
    ports:
      - "8003:8000"
    depends_on:
      rabbitmq:
        condition: service_healthy
    command: sh -c "sleep 10 && ./entrypoint.sh"

  # Auth Worker - Added to handle async sync tasks
  auth-worker:
    build:
      context: ../../auth
      dockerfile: Dockerfile
    env_file:
      - .env
    environment:
      DJANGO_ENV: "development"
      DJANGO_DEBUG: "True"
      DJANGO_SECRET_KEY: "signing-key-1234"
      DJANGO_JWT_SIGNING_KEY: "signing-key-1234"
      KONG_TRUSTED: "true"
      CELERY_BROKER_URL: "amqp://admin:admin@rabbitmq:5672/"
      SENDGRID_API_KEY: "${SENDGRID_API_KEY}"
      SENDGRID_FROM_EMAIL: "notification@noreply.mapactive.tech"
      SENDGRID_FROM_NAME: "MapActive"
      SENDGRID_ENABLED: "True"
    depends_on:
      rabbitmq:
        condition: service_healthy
      db:
        condition: service_started
    command: >
      sh -c "sleep 15 && 
             celery -A auth worker --pool=solo --loglevel=info -Q auth-sync-queue"
    
  # Messaging service - 10 seconds sleep
  messaging-service:
    build:
      context: ../messaging
      dockerfile: Dockerfile
    environment:
      DJANGO_ENV: "development"
      DJANGO_DEBUG: "True"
      DJANGO_SECRET_KEY: "secret-key-1234"
      DJANGO_JWT_SIGNING_KEY: "signing-key-1234"
      DJANGO_ALLOWED_HOSTS: "165.22.247.50,127.0.0.1,messaging-service,host.docker.internal"
      KONG_TRUSTED: "true"
      DJANGO_CORS_ALLOWED_ORIGINS: "http://165.22.247.50:1000,http://127.0.0.1:1000,http://165.22.247.50:5173,http://127.0.0.1:5173,http://165.22.247.50:3000,http://127.0.0.1:3000,http://165.22.247.50:8080"
      DJANGO_CORS_ALLOW_CREDENTIALS: "True"
      DJANGO_MEDIA_BASE_URL: "http://165.22.247.50:1002"
    ports:
      - "1002:8001"
    command: sh -c "sleep 10 && ./entrypoint.sh"
    
  # Notification service - 10 seconds sleep
  notification-service:
    build:
      context: ../notification_service
      dockerfile: Dockerfile
    environment:
      DJANGO_ENV: "production"
      DJANGO_DEBUG: "False"
      DJANGO_SECRET_KEY: "secret-key-1234"
      DJANGO_JWT_SIGNING_KEY: "signing-key-1234"
      DJANGO_ALLOWED_HOSTS: "165.22.247.50,127.0.0.1,notification-service,host.docker.internal"
      KONG_TRUSTED: "true"
      DATABASE_URL: "postgres://postgres:postgrespass@db:5432/notificationservice"
      PGHOST: "db"
      PGPORT: "5432"
      POSTGRES_DB: "notification_db"
      POSTGRES_USER: "postgres"
      POSTGRES_PASSWORD: "postgrespass"
      SENDGRID_API_KEY: "${SENDGRID_API_KEY}"
      SENDGRID_FROM_EMAIL: "notification@noreply.mapactive.tech"
      SENDGRID_FROM_NAME: "MapActive"
      SENDGRID_ENABLED: "True"
      TTS_FRONTEND_URL: "http://165.22.247.50:1000"
      TTS_TICKET_PATH_TEMPLATE: "/ticket/{id}"
      DJANGO_CORS_ALLOWED_ORIGINS: "http://165.22.247.50:1000,http://127.0.0.1:1000,http://165.22.247.50:8080"
      DJANGO_CORS_ALLOW_CREDENTIALS: "True"
      DJANGO_NOTIFICATION_SERVICE_PORT: "8001"
      DJANGO_AUTH_SERVICE_URL: "http://auth-service:8000"
      DJANGO_NOTIFICATION_API_KEYS: "demo-api-key-123,test-api-key-456"
      DJANGO_API_KEY: "in-app-notification-api-key-secure"
      DJANGO_CELERY_BROKER_URL: "amqp://admin:admin@rabbitmq:5672/"
      DJANGO_NOTIFICATION_QUEUE: "notification-queue"
      DJANGO_INAPP_NOTIFICATION_QUEUE: "inapp-notification-queue"
    ports:
      - "1003:8001"
    depends_on:
      rabbitmq:
        condition: service_healthy
    command: sh -c "sleep 10 && ./entrypoint.sh"
    
  # Notification worker - 15 seconds sleep
  notification-worker:
    build:
      context: ../notification_service
      dockerfile: Dockerfile
    environment:
      DJANGO_ENV: "production"
      DJANGO_DEBUG: "False"
      DJANGO_SECRET_KEY: "secret-key-1234"
      DJANGO_JWT_SIGNING_KEY: "signing-key-1234"
      DJANGO_ALLOWED_HOSTS: "165.22.247.50,127.0.0.1,notification-worker"
      KONG_TRUSTED: "true"
      DATABASE_URL: "postgres://postgres:postgrespass@db:5432/notificationservice"
      PGHOST: "db"
      PGPORT: "5432"
      POSTGRES_DB: "notification_db"
      POSTGRES_USER: "postgres"
      POSTGRES_PASSWORD: "postgrespass"
      SENDGRID_API_KEY: "${SENDGRID_API_KEY}"
      SENDGRID_FROM_EMAIL: "notification@noreply.mapactive.tech"
      SENDGRID_FROM_NAME: "MapActive"
      SENDGRID_ENABLED: "True"
      TTS_FRONTEND_URL: "http://165.22.247.50:1000"
      TTS_TICKET_PATH_TEMPLATE: "/ticket/{id}"
      NOTIFICATION_SERVICE_INTERNAL_URL: "http://notification-service:8001"
      DJANGO_AUTH_SERVICE_URL: "http://auth-service:8000"
      DJANGO_NOTIFICATION_API_KEYS: "demo-api-key-123,test-api-key-456"
      DJANGO_API_KEY: "in-app-notification-api-key-secure"
      DJANGO_CELERY_BROKER_URL: "amqp://admin:admin@rabbitmq:5672/"
      DJANGO_NOTIFICATION_QUEUE: "notification-queue"
      DJANGO_INAPP_NOTIFICATION_QUEUE: "inapp-notification-queue"
    depends_on:
      rabbitmq:
        condition: service_healthy
      notification-service:
        condition: service_started
    command: >
      sh -c "sleep 5 && 
             celery -A notification_service worker --pool=solo --loglevel=info -Q notification-queue-default,inapp-notification-queue,user-email-sync-queue"

  # frontend:
  # frontend:
  #   build:
  #     context: ../frontend
  #     dockerfile: Dockerfile
  #   environment:
  #     # the following env var don't get used, the one's from the .env file in the frontend directory get used instead
  #     VITE_AUTH_URL: http://auth-service:8000
  #     VITE_WORKFLOW_API: http://workflow-api:8000/workflow
  #     VITE_BACKEND_API: http://workflow-api:8000/
  #   ports:
  #     - "1000:1000"
  #   depends_on:
  #     - helpdesk-service
  #     - workflow-api

volumes:
  rabbitmq_data:
  postgres_data:
  media_files: