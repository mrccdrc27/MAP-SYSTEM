{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign In - MAP Active</title>

    <!-- External stylesheet -->
    <link rel="stylesheet" href="{% static 'css/login.css' %}">

    <!-- Font Awesome for icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Google reCAPTCHA v2 (only load if enabled) -->
    {% if recaptcha_enabled %}
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
    {% endif %}
    
    <!-- Pass recaptcha settings to JavaScript -->
    <script>
        window.RECAPTCHA_ENABLED = {{ recaptcha_enabled|yesno:"true,false" }};
        window.RECAPTCHA_SITE_KEY = "{{ recaptcha_site_key|default:'' }}";
        // System URLs from environment configuration
        window.SYSTEM_URLS = {
            tts: "{{ tts_system_url|default:'http://localhost:1000' }}",
            ams: "{{ ams_system_url|default:'http://localhost:3000/ams' }}",
            hdts: "{{ hdts_system_url|default:'http://localhost:5173' }}",
            bms: "{{ bms_system_url|default:'http://localhost:3000/bms' }}",
            default: "{{ default_system_url|default:'http://localhost:3000/dashboard' }}"
        };
    </script>
    
    <style>
        .formMode {
            display: none;
            width: 100%;
            flex-direction: column;
            gap: 20px;
        }
        .formMode.active {
            display: flex;
        }
        .infoBox {
            background-color: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 4px;
            padding: 12px;
            font-size: 13px;
            color: #004085;
            width: 100%;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .infoBox i {
            flex-shrink: 0;
        }
        .forgotLink {
            text-align: center;
            width: 100%;
        }
        .forgotLink button {
            background: none;
            border: none;
            color: #007bff;
            text-decoration: none;
            font-size: 14px;
            cursor: pointer;
            padding: 0;
            transition: color 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            margin: 0 auto;
        }
        .forgotLink button:hover {
            color: #0056b3;
            text-decoration: underline;
        }
        #loginMode fieldset,
        #otpMode fieldset {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: start;
            width: 100%;
            gap: 8px;
            border: none;
            padding: 0;
            margin: 0;
        }
        #loginMode fieldset label,
        #otpMode fieldset label {
            font-size: 14px;
            font-weight: 500;
            color: #333;
            margin-bottom: 8px;
            width: 100%;
        }
        #loginMode fieldset input,
        #otpMode fieldset input {
            display: flex;
            width: 100%;
            height: 44px;
            padding: 18px 16px;
            border-radius: 40px;
            border: 1px solid #d3d3d3;
            background-color: #fcfcfc;
            font-size: 14px;
        }
        #loginMode fieldset input::placeholder,
        #otpMode fieldset input::placeholder {
            color: #999;
        }
        .form-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            gap: 20px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }
        .logInButton {
            width: 100%;
        }
        .passwordContainer {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
        }
        .passwordContainer input {
            flex: 1;
        }
        .showPassword {
            cursor: pointer;
            display: none;
            align-items: center;
            padding: 8px;
            color: #666;
        }
        .remember-me {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
        }
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .hidden {
            display: none !important;
        }
    </style>
</head>

<body>
    <!-- Toast Notification Component -->
    {% include "components/toast_notification.html" %}

    <main class="loginPage">
        <!-- Left Panel -->
        <section class="leftPanel">
            <div class="leftImage">
                <img src="{% static 'images/TTS_MAP_BG.png' %}" alt="Background" class="assetImage">
            </div>
        </section>

        <!-- Right Panel -->
        <section class="rightPanel">
            <header class="formHeader">
                <section class="logo">
                    <img src="{% static 'images/map-logo.png' %}" alt="TicketFlow logo" />
                    <h1 class="logoText">Sign In</h1>
                </section>
                <p>Welcome! Please provide your credentials to log in.</p>
            </header>

            <!-- Login / OTP Form -->
            <form id="loginForm" novalidate class="lpForm" autocomplete="off">
                <!-- Login Mode -->
                <div id="loginMode" class="formMode active">
                    <!-- Email -->
                    <fieldset>
                        <label for="email">Email:</label>
                        <input type="email" id="email" name="email" required placeholder="Enter your email">
                    </fieldset>

                    <!-- Password -->
                    <fieldset>
                        <label for="password">Password:</label>
                        <div class="passwordContainer">
                            <input type="password" id="password" name="password" required placeholder="Enter your password">
                            <span class="showPassword" data-target="password" title="Show password">
                                <i class="fa-solid fa-eye"></i>
                            </span>
                        </div>
                    </fieldset>

                    <!-- Remember Me -->
                    <div class="remember-me">
                        <input type="checkbox" id="rememberMe" name="remember_me">
                        <label for="rememberMe">Remember me</label>
                    </div>

                    <!-- reCAPTCHA v2 Checkbox (only show if enabled) -->
                    {% if recaptcha_enabled %}
                    <div class="g-recaptcha" data-sitekey="{{ recaptcha_site_key }}"></div>
                    {% endif %}

                    <!-- Submit Button -->
                    <button type="submit" class="logInButton" id="loginButton">
                        <span class="buttonText">Log In</span>
                        <span class="spinner hidden"></span>
                    </button>
                </div>

                <!-- OTP Mode -->
                <div id="otpMode" class="formMode">
                    <!-- OTP Info Box -->
                    <div class="infoBox">
                        <i class="fa-solid fa-info-circle"></i> Enter the 6-digit code sent to your email address.
                    </div>

                    <!-- OTP Code Input -->
                    <fieldset>
                        <label for="otpCode">OTP Code:</label>
                        <input type="text" id="otpCode" name="otp_code" maxlength="6" placeholder="Enter 6-digit code" pattern="[0-9]{6}" inputmode="numeric" required>
                    </fieldset>

                    <!-- OTP Submit Button -->
                    <button type="submit" class="logInButton" id="otpButton">
                        <span class="buttonText">Verify OTP</span>
                        <span class="spinner hidden"></span>
                    </button>

                    <!-- Back to Login Toggle -->
                    <div class="forgotLink">
                        <button type="button" class="backToLogin">
                            <i class="fa-solid fa-arrow-left"></i> Back to Login
                        </button>
                    </div>
                </div>

                <!-- Forgot Password Mode -->
                <div id="forgotPasswordMode" class="formMode">
                    <!-- Reset Password Info -->
                    <div class="infoBox">
                        <i class="fa-solid fa-info-circle"></i> Enter your email address and we'll send you a link to reset your password.
                    </div>

                    <!-- Email for Reset -->
                    <fieldset>
                        <label for="resetEmail">Email Address:</label>
                        <input type="email" id="resetEmail" name="reset_email" placeholder="Enter your registered email">
                    </fieldset>

                    <!-- Reset Submit Button -->
                    <button type="button" class="logInButton" id="resetButton" style="margin-top: 10px;">
                        <span class="buttonText">Send Reset Link</span>
                        <span class="spinner hidden"></span>
                    </button>

                    <!-- Back to Login Toggle -->
                    <div class="forgotLink">
                        <button type="button" id="backToLoginFromForgot">
                            <i class="fa-solid fa-arrow-left"></i> Back to Login
                        </button>
                    </div>
                </div>
            </form>

            <!-- Register & Navigation -->
            <div class="form-footer">
                <div class="forgotLink">
                    <button type="button" id="toggleForgotPassword">
                        <i class="fa-solid fa-question-circle"></i> Forgot Password?
                    </button>
                </div>
                <a href="{% url 'employee-login-shortcut' %}" style="color: #666; text-decoration: none; font-size: 14px; display: block; text-align: center; transition: color 0.3s;" onmouseover="this.style.color='#007bff'" onmouseout="this.style.color='#666';"><i class="fa-solid fa-headset"></i> Login to Help Desk </a>
            </div>
        </section>
    </main>

    <!-- JS -->
    <script>
        // State management for login flow
        let loginState = {
            email: '',
            password: '',
            temporaryToken: '',
            isSubmitting: false,
            rememberMe: false
        };

        document.addEventListener('DOMContentLoaded', function () {
            const loginForm = document.getElementById('loginForm');
            const loginMode = document.getElementById('loginMode');
            const otpMode = document.getElementById('otpMode');
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            const otpInput = document.getElementById('otpCode');
            const loginButton = document.getElementById('loginButton');
            const otpButton = document.getElementById('otpButton');
            const backToLoginBtn = document.querySelector('.backToLogin');

            // Display any Django messages
            const messagesData = document.querySelector('[data-messages]');
            if (messagesData) {
                try {
                    const messages = JSON.parse(messagesData.getAttribute('data-messages'));
                    messages.forEach(msg => {
                        const type = msg.tags || 'info';
                        ToastNotification[type](msg.message);
                    });
                } catch (e) {
                    console.error('Failed to parse messages:', e);
                }
            }

            // Password visibility toggle
            document.querySelectorAll('.showPassword').forEach(toggle => {
                const targetId = toggle.getAttribute('data-target');
                const input = document.getElementById(targetId);
                
                toggle.addEventListener('click', function () {
                    const icon = this.querySelector('i');
                    if (input.type === 'password') {
                        input.type = 'text';
                        icon.classList.replace('fa-eye', 'fa-eye-slash');
                        this.setAttribute('title', 'Hide password');
                    } else {
                        input.type = 'password';
                        icon.classList.replace('fa-eye-slash', 'fa-eye');
                        this.setAttribute('title', 'Show password');
                    }
                });

                // Show/hide eye icon based on input value
                input.addEventListener('input', function() {
                    if (this.value.length > 0) {
                        toggle.style.display = 'flex';
                    } else {
                        toggle.style.display = 'none';
                    }
                });
            });

            // OTP input - only allow numeric characters and auto-submit on 6 digits
            otpInput.addEventListener('keypress', function(e) {
                if (!/[0-9]/.test(e.key)) {
                    e.preventDefault();
                }
            });

            otpInput.addEventListener('input', function() {
                this.value = this.value.replace(/[^0-9]/g, '');
                
                // Auto-submit if 6 digits are entered
                if (this.value.length === 6) {
                    setTimeout(() => {
                        otpButton.click();
                    }, 100);
                }
            });

            // Back to Login button
            backToLoginBtn.addEventListener('click', function(e) {
                e.preventDefault();
                loginState.temporaryToken = '';
                otpInput.value = '';
                otpMode.classList.remove('active');
                loginMode.classList.add('active');
                emailInput.focus();
            });

            // Back to Login from Forgot Password
            const backToLoginFromForgotBtn = document.getElementById('backToLoginFromForgot');
            if (backToLoginFromForgotBtn) {
                backToLoginFromForgotBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    document.getElementById('resetEmail').value = '';
                    document.getElementById('forgotPasswordMode').classList.remove('active');
                    loginMode.classList.add('active');
                });
            }

            // Toggle Forgot Password
            const toggleForgotPasswordBtn = document.getElementById('toggleForgotPassword');
            if (toggleForgotPasswordBtn) {
                toggleForgotPasswordBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    loginMode.classList.remove('active');
                    document.getElementById('forgotPasswordMode').classList.add('active');
                });
            }

            // Handle Forgot Password Submit
            const resetButton = document.getElementById('resetButton');
            if (resetButton) {
                resetButton.addEventListener('click', async function(e) {
                    e.preventDefault();
                    const resetEmailInput = document.getElementById('resetEmail');
                    const email = resetEmailInput.value.trim();
                    const btn = this;
                    const btnText = btn.querySelector('.buttonText');
                    const spinner = btn.querySelector('.spinner');

                    if (!email) {
                        ToastNotification.error('Invalid Input', 'Please enter your email address.');
                        return;
                    }

                    btn.disabled = true;
                    btnText.textContent = 'Sending...';
                    spinner.classList.remove('hidden');

                    try {
                        const response = await fetch('/api/v1/users/password/forgot/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': document.querySelector('[name="csrfmiddlewaretoken"]')?.value || ''
                            },
                            body: JSON.stringify({ email: email })
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            ToastNotification.success('Email Sent', 'If an account exists with this email, you will receive password reset instructions.');
                            resetEmailInput.value = '';
                            setTimeout(() => {
                                document.getElementById('forgotPasswordMode').classList.remove('active');
                                loginMode.classList.add('active');
                            }, 2000);
                        } else {
                            ToastNotification.error('Error', data.detail || data.error || 'Failed to send reset email.');
                        }
                    } catch (error) {
                        console.error('Forgot password error:', error);
                        ToastNotification.error('Error', 'An error occurred. Please try again.');
                    } finally {
                        btn.disabled = false;
                        btnText.textContent = 'Send Reset Link';
                        spinner.classList.add('hidden');
                    }
                });
            }

            // Form submission handler
            loginForm.addEventListener('submit', function (e) {
                e.preventDefault();
                e.stopPropagation();

                if (loginState.isSubmitting) {
                    console.log('Submission already in progress');
                    return false;
                }

                // Check if we're in OTP mode
                if (otpMode.classList.contains('active')) {
                    handleOTPSubmission();
                } else {
                    handleLoginSubmission();
                }

                return false;
            });

            async function handleLoginSubmission() {
                console.log('handleLoginSubmission called.');

                // Validate inputs
                const email = emailInput.value.trim();
                const password = passwordInput.value.trim();
                const rememberMe = document.getElementById('rememberMe').checked;

                if (!email || !password) {
                    ToastNotification.error('Invalid Input', 'Email and password are required.');
                    return;
                }

                // Check reCAPTCHA only if enabled
                let recaptchaResponse = '';
                if (window.RECAPTCHA_ENABLED) {
                    if (typeof grecaptcha === 'undefined') {
                        ToastNotification.error('Security Error', 'reCAPTCHA failed to load. Please refresh and try again.');
                        return;
                    }

                    recaptchaResponse = grecaptcha.getResponse();
                    if (!recaptchaResponse) {
                        ToastNotification.warning('reCAPTCHA Required', 'Please complete the reCAPTCHA verification before logging in.');
                        return;
                    }
                }

                // Show loading state
                loginState.isSubmitting = true;
                loginButton.disabled = true;
                const buttonText = loginButton.querySelector('.buttonText');
                const spinner = loginButton.querySelector('.spinner');
                buttonText.textContent = 'Logging in...';
                spinner.classList.remove('hidden');

                try {
                    // Call login API
                    const response = await fetch('/api/v1/users/login/api/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('[name="csrfmiddlewaretoken"]')?.value || ''
                        },
                        body: JSON.stringify({
                            email: email,
                            password: password,
                            g_recaptcha_response: recaptchaResponse
                        })
                    });

                    const data = await response.json();

                    if (response.status === 200 && data.otp_required) {
                        // OTP is required - show OTP mode
                        console.log('OTP required');
                        loginState.email = email;
                        loginState.password = password;
                        loginState.temporaryToken = data.temporary_token;
                        loginState.rememberMe = rememberMe;

                        ToastNotification.info('Two-Factor Authentication', data.message);
                        
                        loginMode.classList.remove('active');
                        otpMode.classList.add('active');
                        otpInput.focus();
                    } else if (response.status === 200 && data.success) {
                        // Login successful
                        console.log('Login successful');
                        ToastNotification.success('Login Successful', 'Redirecting to your dashboard...', 1500);

                        // Set cookies
                        document.cookie = `access_token=${data.access_token}; path=/`;
                        document.cookie = `refresh_token=${data.refresh_token}; path=/`;

                        // Redirect to the appropriate system URL from response or default
                        const redirectUrl = data.redirect?.url || window.SYSTEM_URLS.default;
                        setTimeout(() => {
                            window.location.href = redirectUrl;
                        }, 1500);
                    } else {
                        // Login failed
                        const errorMsg = data.errors?.non_field_errors?.[0] || 
                                        data.errors?.email?.[0] || 
                                        data.errors?.password?.[0] ||
                                        data.errors?.g_recaptcha_response?.[0] ||
                                        data.detail ||
                                        'Login failed. Please try again.';
                        
                        ToastNotification.error('Login Failed', errorMsg);
                        
                        // Reset reCAPTCHA if enabled
                        if (window.RECAPTCHA_ENABLED && typeof grecaptcha !== 'undefined') {
                            grecaptcha.reset();
                        }
                    }
                } catch (error) {
                    console.error('Login error:', error);
                    ToastNotification.error('Error', 'An error occurred. Please try again.');
                } finally {
                    loginState.isSubmitting = false;
                    loginButton.disabled = false;
                    buttonText.textContent = 'Log In';
                    spinner.classList.add('hidden');
                }
            }

            async function handleOTPSubmission() {
                console.log('handleOTPSubmission called.');

                const otpCode = otpInput.value.trim();

                if (!otpCode || otpCode.length !== 6 || !/^\d{6}$/.test(otpCode)) {
                    ToastNotification.error('Invalid OTP', 'Please enter a valid 6-digit code.');
                    return;
                }

                if (!loginState.temporaryToken) {
                    ToastNotification.error('Session Error', 'Session expired. Please log in again.');
                    otpMode.classList.remove('active');
                    loginMode.classList.add('active');
                    return;
                }

                // Show loading state
                loginState.isSubmitting = true;
                otpButton.disabled = true;
                const buttonText = otpButton.querySelector('.buttonText');
                const spinner = otpButton.querySelector('.spinner');
                buttonText.textContent = 'Verifying...';
                spinner.classList.remove('hidden');

                try {
                    // Call OTP verify API
                    const response = await fetch('/api/v1/users/login/verify-otp/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('[name="csrfmiddlewaretoken"]')?.value || ''
                        },
                        body: JSON.stringify({
                            temporary_token: loginState.temporaryToken,
                            otp_code: otpCode
                        })
                    });

                    const data = await response.json();

                    if (response.status === 200 && data.success) {
                        // OTP verified successfully
                        console.log('OTP verified');
                        ToastNotification.success('Login Successful', 'Redirecting to your dashboard...', 1500);

                        // Set cookies
                        document.cookie = `access_token=${data.access_token}; path=/`;
                        document.cookie = `refresh_token=${data.refresh_token}; path=/`;

                        // Redirect to the appropriate system URL from response or default
                        const redirectUrl = data.redirect?.url || window.SYSTEM_URLS.default;
                        setTimeout(() => {
                            window.location.href = redirectUrl;
                        }, 1500);
                    } else if (data.otp_expired) {
                        ToastNotification.error('OTP Expired', data.error || 'Your OTP has expired. Please log in again.');
                        setTimeout(() => {
                            loginState.temporaryToken = '';
                            otpInput.value = '';
                            otpMode.classList.remove('active');
                            loginMode.classList.add('active');
                            emailInput.focus();
                        }, 2000);
                    } else {
                        ToastNotification.error('Invalid OTP', data.error || 'Invalid OTP code. Please try again.');
                    }
                } catch (error) {
                    console.error('OTP verification error:', error);
                    ToastNotification.error('Error', 'An error occurred during OTP verification. Please try again.');
                } finally {
                    loginState.isSubmitting = false;
                    otpButton.disabled = false;
                    buttonText.textContent = 'Verify OTP';
                    spinner.classList.add('hidden');
                }
            }
        });
    </script>
</body>

</html>
