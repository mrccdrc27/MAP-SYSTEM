{% load static %}
<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Employee Login - HDTS</title>

        <!-- External stylesheet -->
        <link rel="stylesheet" href="{% static 'css/login.css' %}">

        <!-- Font Awesome for icons -->
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
        
        <!-- Google reCAPTCHA v2 (only load if enabled) -->
        {% if recaptcha_enabled %}
        <script src="https://www.google.com/recaptcha/api.js" async defer></script>
        {% endif %}
        
        <!-- Pass recaptcha settings to JavaScript -->
        <script>
            window.RECAPTCHA_ENABLED = {{ recaptcha_enabled|yesno:"true,false" }};
            window.RECAPTCHA_SITE_KEY = "{{ recaptcha_site_key|default:'' }}";
        </script>
        
        <style>
            .formMode {
                display: none;
                width: 100%;
            }
            .formMode.active {
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                width: 100%;
                gap: 20px;
            }
            .infoBox {
                background-color: #e7f3ff;
                border: 1px solid #b3d9ff;
                border-radius: 4px;
                padding: 12px;
                margin-bottom: 15px;
                font-size: 13px;
                color: #004085;
                width: 100%;
            }
            .forgotLink {
                text-align: center;
            }
            .forgotLink button {
                background: none;
                border: none;
                color: #007bff;
                text-decoration: none;
                font-size: 14px;
                cursor: pointer;
                padding: 0;
                transition: color 0.3s;
            }
            .forgotLink button:hover {
                color: #0056b3;
                text-decoration: underline;
            }
            #loginMode fieldset,
            #forgotPasswordMode fieldset {
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: start;
                width: 100%;
                gap: 8px;
            }
            #loginMode fieldset input,
            #forgotPasswordMode fieldset input {
                display: flex;
                width: 100%;
                height: 44px;
                padding: 18px 16px;
                border-radius: 40px;
                border: 1px solid #d3d3d3;
                background-color: #fcfcfc;
            }
            .form-footer {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 15px;
            }
            .links-row {
                display: flex;
                justify-content: space-between;
                width: 100%;
            }
        </style>
    </head><body>
    <!-- Toast Notification Component -->
    {% include "components/toast_notification.html" %}

    <main class="loginPage">
        <!-- Left Panel -->
        <section class="leftPanel">
            <div class="leftImage">
                <img src="{% static 'images/TTS_MAP_BG.png' %}" alt="Background" class="assetImage">
            </div>
        </section>

        <!-- Right Panel -->
        <section class="rightPanel">
            <header class="formHeader">
                <section class="logo">
                    <img src="{% static 'images/map-logo.png' %}" alt="HDTS logo" />
                    <h1 class="logoText">Help Desk Sign In</h1>
                </section>
                <p>Welcome! Please provide your credentials to log in.</p>
            </header>

            <!-- Login / OTP / Forgot Password Form -->
            <form method="post" novalidate class="lpForm" data-two-factor="{{ requires_otp|default:False }}" id="loginFormMain">
                {% csrf_token %}

                <!-- Login Mode -->
                <div id="loginMode" class="formMode active">
                    {# If requires_otp is not True, show the normal credential inputs #}
                    {% if not requires_otp %}
                    <!-- Email -->
                    <fieldset>
                        <label for="id_email">Email:</label>
                        <input type="email" id="id_email" name="email" required placeholder="Enter your email">
                    </fieldset>

                    <!-- Password -->
                    <fieldset>
                        <label for="id_password">Password:</label>
                        <div class="passwordContainer">
                            <input type="password" id="id_password" name="password" required placeholder="Enter your password">
                            <span class="showPassword" data-target="id_password" title="Show password">
                                <i class="fa-solid fa-eye"></i>
                            </span>
                        </div>
                    </fieldset>

                    <!-- reCAPTCHA v2 Checkbox (only show if enabled) -->
                    {% if recaptcha_enabled %}
                    <div class="g-recaptcha" data-sitekey="{{ recaptcha_site_key }}"></div>
                    {% endif %}

                    <!-- Submit Button -->
                    <button type="submit" class="logInButton" id="loginButton" data-original-text="Sign In">
                        <span class="buttonText">Sign In</span>
                        <span class="spinner" style="display:none;"></span>
                    </button>

                    {% endif %}
                </div>

                <!-- OTP Mode -->
                <div id="otpMode" class="formMode">
                    <!-- OTP Info -->
                    <div class="infoBox">
                        <i class="fa-solid fa-mobile"></i> Enter the One-Time Password (OTP) sent to your email.
                    </div>

                    <!-- Hidden email input for OTP submission -->
                    <input type="hidden" name="email" id="otp_email">

                    <!-- OTP Code Input -->
                    <fieldset>
                        <label for="otp_code">OTP Code:</label>
                        <input type="text" id="otp_code" name="otp_code" placeholder="Enter 6-digit code" maxlength="6" inputmode="numeric" required>
                    </fieldset>

                    <!-- Verify OTP Submit Button -->
                    <button type="submit" class="logInButton" id="otpButton">
                        <span class="buttonText">Verify OTP</span>
                        <span class="spinner" style="display:none;"></span>
                    </button>

                    <!-- Back to Login Toggle -->
                    <div class="forgotLink">
                        <button type="button" id="backToLoginFromOtp">
                            <i class="fa-solid fa-arrow-left"></i> Back to Login
                        </button>
                    </div>
                </div>

                <!-- Forgot Password Mode -->
                <div id="forgotPasswordMode" class="formMode">
                    <!-- Reset Password Info -->
                    <div class="infoBox">
                        <i class="fa-solid fa-info-circle"></i> Enter your email address and we'll send you a link to reset your password.
                    </div>

                    <!-- Email for Reset -->
                    <fieldset>
                        <label for="reset_email">Email Address:</label>
                        <input type="email" id="reset_email" name="reset_email" required placeholder="Enter your registered email">
                    </fieldset>

                    <!-- Reset Submit Button -->
                    <button type="button" class="logInButton" id="resetButton" style="margin-top: 10px;">
                        <span class="buttonText">Send Reset Link</span>
                        <span class="spinner" style="display:none;"></span>
                    </button>

                    <!-- Back to Login Toggle -->
                    <div class="forgotLink">
                        <button type="button" id="backToLoginBtn">
                            <i class="fa-solid fa-arrow-left"></i> Back to Login
                        </button>
                    </div>
                </div>

            <!-- Register Link & Navigation -->
            <div class="form-footer">
                <div class="links-row">
                    <div class="forgotLink">
                        <button type="button" id="toggleForgotPassword">
                            <i class="fa-solid fa-question-circle"></i> Forgot Password?
                        </button>
                    </div>
                    <a href="{% url 'auth_login' %}" style="color: #666; text-decoration: none; font-size: 14px; display: block; text-align: center; transition: color 0.3s;" onmouseover="this.style.color='#007bff'" onmouseout="this.style.color='#666';"><i class="fa-solid fa-user-tie"></i> Login as Staff</a>
                </div>
                <a href="{% url 'employee-register-shortcut' %}" style="color: #666; text-decoration: none; font-size: 14px; display: block; text-align: center; transition: color 0.3s;" onmouseover="this.style.color='#007bff'" onmouseout="this.style.color='#666';"><i class="fa-solid fa-user-plus"></i> Create an account</a>
            </div>
        </section>
    </main>

    <!-- JS -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Password visibility toggle
            document.querySelectorAll('.showPassword').forEach(toggle => {
                const targetId = toggle.getAttribute('data-target');
                const passwordInput = document.getElementById(targetId);
                
                // Function to show/hide eye icon based on input value
                const updateIconVisibility = () => {
                    if (passwordInput.value.length > 0) {
                        toggle.style.display = 'flex';
                    } else {
                        toggle.style.display = 'none';
                    }
                };
                
                // Initial check
                updateIconVisibility();
                
                // Update on input
                passwordInput.addEventListener('input', updateIconVisibility);
                
                // Toggle visibility on click
                toggle.addEventListener('click', function () {
                    const icon = this.querySelector('i');

                    if (passwordInput.type === 'password') {
                        passwordInput.type = 'text';
                        icon.classList.replace('fa-eye', 'fa-eye-slash');
                        this.setAttribute('title', 'Hide password');
                    } else {
                        passwordInput.type = 'password';
                        icon.classList.replace('fa-eye-slash', 'fa-eye');
                        this.setAttribute('title', 'Show password');
                    }
                });
            });

            // Toggle between login and forgot password modes
            const toggleForgotPassword = document.getElementById('toggleForgotPassword');
            const backToLoginBtn = document.getElementById('backToLoginBtn');
            const backToLoginFromOtp = document.getElementById('backToLoginFromOtp');
            const loginMode = document.getElementById('loginMode');
            const forgotPasswordMode = document.getElementById('forgotPasswordMode');
            const otpMode = document.getElementById('otpMode');

            if (toggleForgotPassword) {
                toggleForgotPassword.addEventListener('click', function(e) {
                    e.preventDefault();
                    loginMode.classList.remove('active');
                    forgotPasswordMode.classList.add('active');
                });
            }

            if (backToLoginBtn) {
                backToLoginBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    loginMode.classList.add('active');
                    forgotPasswordMode.classList.remove('active');
                    document.getElementById('reset_email').value = '';
                });
            }

            if (backToLoginFromOtp) {
                backToLoginFromOtp.addEventListener('click', function(e) {
                    e.preventDefault();
                    otpMode.classList.remove('active');
                    loginMode.classList.add('active');
                    document.getElementById('otp_code').value = '';
                    document.getElementById('id_email').focus();
                    // Reset reCAPTCHA for retry if enabled
                    if (window.RECAPTCHA_ENABLED && typeof grecaptcha !== 'undefined') {
                        grecaptcha.reset();
                    }
                });
            }

            // Handle forgot password submission
            const resetButton = document.getElementById('resetButton');
            if (resetButton) {
                resetButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    const email = document.getElementById('reset_email').value.trim();
                    
                    if (!email) {
                        ToastNotification.error('Invalid Input', 'Email address is required.');
                        return;
                    }

                    resetButton.disabled = true;
                    const buttonText = resetButton.querySelector('.buttonText');
                    const spinner = resetButton.querySelector('.spinner');
                    buttonText.textContent = 'Sending...';
                    spinner.style.display = 'inline-block';

                    // Call the API endpoint for forgot password
                    fetch('/api/v1/hdts/employees/api/password/forgot/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        },
                        body: JSON.stringify({ email: email })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success || data.message) {
                            ToastNotification.success('Email Sent', 'Check your email for password reset instructions.');
                            document.getElementById('reset_email').value = '';
                            
                            // After 2 seconds, switch back to login
                            setTimeout(() => {
                                loginMode.classList.add('active');
                                forgotPasswordMode.classList.remove('active');
                            }, 2000);
                        } else {
                            ToastNotification.error('Error', data.error || 'Failed to send reset email.');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        ToastNotification.error('Error', 'An error occurred. Please try again.');
                    })
                    .finally(() => {
                        resetButton.disabled = false;
                        buttonText.textContent = 'Send Reset Link';
                        spinner.style.display = 'none';
                    });
                });
            }

            // Handle form submission
            const loginForm = document.querySelector('.lpForm');
            const loginButton = document.getElementById('loginButton');
            const otpButton = document.getElementById('otpButton');
            
            let isFormSubmitting = false;
            
            loginForm.addEventListener('submit', function (e) {
                e.preventDefault();
                
                if (isFormSubmitting) {
                    return false;
                }
                
                // Check reCAPTCHA only if enabled
                let recaptchaResponse = '';
                if (window.RECAPTCHA_ENABLED) {
                    // Check if grecaptcha is available
                    if (typeof grecaptcha === 'undefined') {
                        console.error('reCAPTCHA not loaded');
                        ToastNotification.error('Security Error', 'Security verification failed to load. Please refresh the page.');
                        return false;
                    }
                    
                    // Get reCAPTCHA response from the checkbox widget
                    recaptchaResponse = grecaptcha.getResponse();
                    
                    if (!recaptchaResponse) {
                        ToastNotification.warning('reCAPTCHA Required', 'Please complete the reCAPTCHA verification.');
                        return false;
                    }
                }
                
                const isTwoFactor = loginForm.getAttribute('data-two-factor') === 'True';
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                
                let payload = {};
                
                if (isTwoFactor) {
                    // OTP submission
                    const otpCode = document.querySelector('input[name="otp_code"]').value;
                    const email = document.querySelector('input#otp_email').value;
                    if (!otpCode) {
                        ToastNotification.error('Invalid Input', 'OTP code is required.');
                        return;
                    }
                    payload = { email: email, otp_code: otpCode };
                } else {
                    // Regular login
                    const email = document.querySelector('input[name="email"]').value;
                    const password = document.querySelector('input[name="password"]').value;
                    
                    if (!email || !password) {
                        ToastNotification.error('Invalid Input', 'Email and password are required.');
                        return;
                    }
                    payload = { 
                        email: email, 
                        password: password,
                        g_recaptcha_response: recaptchaResponse
                    };
                }
                
                isFormSubmitting = true;
                
                // Disable submit buttons and show loading state
                [loginButton, otpButton].forEach(btn => {
                    if (btn) {
                        btn.disabled = true;
                        const buttonText = btn.querySelector('.buttonText');
                        const spinner = btn.querySelector('.spinner');
                        
                        buttonText.textContent = isTwoFactor ? 'Verifying...' : 'Signing in...';
                        spinner.style.display = 'inline-block';
                    }
                });
                
                // Make API call to login endpoint
                const apiEndpoint = isTwoFactor ? '/api/v1/hdts/employees/api/2fa/verify-otp/' : '/api/v1/hdts/employees/api/login/';
                
                fetch(apiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify(payload)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.access || data.success) {
                        // Store tokens if provided
                        if (data.access) {
                            localStorage.setItem('access_token', data.access);
                            localStorage.setItem('refresh_token', data.refresh);
                        }
                        ToastNotification.success('Success', 'Logged in successfully!');
                        // Redirect to frontend - let the frontend handle routing based on JWT
                        const frontendUrl = 'http://localhost:5173';
                        setTimeout(() => {
                            window.location.href = frontendUrl;
                        }, 1500);
                    } else if (data.requires_otp) {
                        // 2FA required - store email and switch to OTP mode
                        const userEmail = document.querySelector('input[name="email"]').value;
                        document.getElementById('otp_email').value = userEmail;
                        ToastNotification.info('2FA Required', 'OTP sent to your email.');
                        loginForm.setAttribute('data-two-factor', 'True');
                        loginMode.classList.remove('active');
                        otpMode.classList.add('active');
                        document.getElementById('otp_code').focus();
                    } else if (data.errors) {
                        // Handle structured error response
                        const errorMessages = [];
                        for (const [field, messages] of Object.entries(data.errors)) {
                            if (Array.isArray(messages)) {
                                errorMessages.push(messages[0]);
                            } else if (typeof messages === 'string') {
                                errorMessages.push(messages);
                            }
                        }
                        const errorMsg = errorMessages.length > 0 ? errorMessages[0] : 'Login failed. Please try again.';
                        ToastNotification.error('Login Failed', errorMsg);
                        
                        // Reset reCAPTCHA for retry if enabled
                        if (window.RECAPTCHA_ENABLED && typeof grecaptcha !== 'undefined') {
                            grecaptcha.reset();
                        }
                    } else {
                        ToastNotification.error('Error', data.detail || data.message || 'Login failed. Please try again.');
                        
                        // Reset reCAPTCHA for retry if enabled
                        if (window.RECAPTCHA_ENABLED && typeof grecaptcha !== 'undefined') {
                            grecaptcha.reset();
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    ToastNotification.error('Error', 'An error occurred. Please try again.');
                    
                    // Reset reCAPTCHA for retry if enabled
                    if (window.RECAPTCHA_ENABLED && typeof grecaptcha !== 'undefined') {
                        grecaptcha.reset();
                    }
                })
                .finally(() => {
                    isFormSubmitting = false;
                    [loginButton, otpButton].forEach(btn => {
                        if (btn) {
                            btn.disabled = false;
                            const buttonText = btn.querySelector('.buttonText');
                            const spinner = btn.querySelector('.spinner');
                            buttonText.textContent = isTwoFactor ? 'Verify OTP' : 'Sign In';
                            spinner.style.display = 'none';
                        }
                    });
                });
            });

            // Toast auto-hide
            const toasts = document.querySelectorAll('.toast');
            toasts.forEach(toast => {
                setTimeout(() => {
                    toast.style.opacity = '0';
                    setTimeout(() => toast.remove(), 300);
                }, 5000);
            });

            // Handle Back to Login button for OTP mode
            const backToLoginBtn2 = document.querySelector('.backToLogin');
            if (backToLoginBtn2) {
                backToLoginBtn2.addEventListener('click', function(e) {
                    e.preventDefault();
                    isFormSubmitting = false;
                    window.location.href = this.href + '?clear_otp=1&t=' + Date.now();
                });
            }
        });
    </script>
</body>

</html>
