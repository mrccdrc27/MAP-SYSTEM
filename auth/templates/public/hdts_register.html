{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Account - SmartSupport</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <link rel="stylesheet" href="{% static 'hdts/styles.css' %}">
</head>
<body>
    <div class="container">
        <section class="left-panel">
            <img src="https://images.unsplash.com/photo-1556761175-b413da4baf72?w=800&h=1200&fit=crop" alt="Create Account" class="asset-image">
        </section>

        <section class="right-panel">
            <div class="form-wrapper">
                {% if messages %}
                <ul class="messages">
                    {% for message in messages %}
                    <li class="{{ message.tags }}">{{ message }}</li>
                    {% endfor %}
                </ul>
                {% endif %}

                <header class="form-header">
                    <div class="logo">
                        <img src="{% static 'hdts/MapLogo.png' %}" alt="SmartSupport logo" class="logo-icon">
                        <h1 class="logo-text">SmartSupport</h1>
                    </div>
                    <h2>Create Account</h2>
                    <p class="welcome-message">
                        Welcome! As an Employee, you can create your account below.
                    </p>
                </header>

                <form method="post" enctype="multipart/form-data" novalidate id="registerForm">
                    {% csrf_token %}

                    <p class="back-to-login">
                        Already have an account? <a href="{% url 'employee-login-shortcut' %}"><i class="fas fa-sign-in-alt"></i>&nbsp;Log In</a>
                    </p>

                    <!-- Error message container -->
                    <div id="errorContainer" class="fieldset" style="display: none;">
                        <div class="error-msg" id="errorMessage"></div>
                    </div>

                    {% if form.non_field_errors %}
                    <div class="fieldset">
                        <div class="error-msg">
                            {% for error in form.non_field_errors %}
                            {{ error }}
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    {% include 'components/hdts/register_form_fields.html' %}

                    <button type="submit" class="submit-button">
                        <i class="fas fa-user-plus"></i>&nbsp;&nbsp;Sign Up
                    </button>

                </form>
            </div>
        </section>
    </div>

    <!-- Modal for Image Cropper -->
    <div class="modal-overlay" id="cropperModal">
        <div class="modal-container cropper-modal-container">
            <div class="modal-header">
                <h2>Crop Profile Picture (1:1)</h2>
                <button type="button" class="modal-close-btn" onclick="closeCropperModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="cropper-content">
                <div class="cropper-wrapper">
                    <img id="cropperImage" src="" alt="Image for cropping">
                </div>
                <div class="cropper-preview">
                    <div class="preview-label">Preview</div>
                    <div class="preview-container" id="previewContainer"></div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="modal-btn" onclick="closeCropperModal()">
                    <i class="fas fa-times"></i>&nbsp;Cancel
                </button>
                <button type="button" class="modal-btn primary" onclick="saveCropperImage()">
                    <i class="fas fa-check"></i>&nbsp;Save
                </button>
            </div>
        </div>
    </div>

    <!-- Modal for Privacy Policy & Terms -->
    <div class="modal-overlay" id="policyModal">
        <div class="modal-container">
            <div class="modal-header">
                <h2 id="modalTitle">Privacy Policy</h2>
                <button type="button" class="modal-close-btn" onclick="closeModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="modal-content" id="modalContent" onscroll="handleModalScroll()">
                <!-- Content will be populated by JavaScript -->
            </div>

            <div class="modal-footer">
                <button type="button" class="modal-btn" id="backBtn" onclick="goBackStep()" style="display: none;">
                    <i class="fas fa-arrow-left"></i>&nbsp;Back
                </button>
                <button type="button" class="modal-btn primary" id="nextBtn" onclick="goNextStep()" disabled>
                    Next&nbsp;<i class="fas fa-arrow-right"></i>
                </button>
                <button type="button" class="modal-btn primary" id="agreeBtn" onclick="handleAgree()" style="display: none;" disabled>
                    <i class="fas fa-check"></i>&nbsp;I Agree
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script>
        // Toggle password visibility
        function togglePasswordVisibility(element, fieldId) {
            const field = document.getElementById(fieldId);
            const icon = element.querySelector('i');
            
            if (field.type === 'password') {
                field.type = 'text';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            } else {
                field.type = 'password';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            }
        }

        // Current step in modal: 'privacy' or 'terms'
        let currentStep = 'privacy';
        let scrolledToBottom = false;

        // Privacy Policy content
        const privacyPolicyContent = `
            <p>This Privacy Policy outlines how the SmartSupport: AI-Powered Helpdesk Ticketing System collects, uses, stores, and protects the personal data of users who access and use the System.</p>
            
            <h3>1. Information We Collect</h3>
            <p>When you use the System, we may collect the following types of information:</p>
            <ul>
                <li><strong>Personal Information:</strong> Name, employee ID, email address, department, or other identifiers.</li>
                <li><strong>Ticket Information:</strong> The content of your submitted tickets, including descriptions of issues, attachments, and time of submission.</li>
                <li><strong>Usage Data:</strong> Logs such as login timestamps, device/browser information, and activity within the System.</li>
            </ul>
            
            <h3>2. How We Use Your Information</h3>
            <p>We use your data for the following purposes:</p>
            <ul>
                <li>To process and respond to your support requests.</li>
                <li>To track and manage the status of tickets.</li>
                <li>To generate internal reports for service improvement.</li>
                <li>To notify you about the progress or resolution of your submitted tickets.</li>
                <li>To improve user experience and system functionality.</li>
            </ul>
            
            <h3>3. Data Sharing and Disclosure</h3>
            <p>We do <strong>not</strong> sell or share your personal data with external third parties. However, your data may be accessed by:</p>
            <ul>
                <li>Authorized support personnel (e.g., ticket agents, system administrators) for the purpose of resolving your tickets.</li>
                <li>Internal management for service reporting or audits.</li>
            </ul>
            <p>We may disclose your data when legally required (e.g., in response to a court order or legal investigation).</p>
            
            <h3>4. Data Retention</h3>
            <p>We retain your personal and ticket data only for as long as necessary to fulfill the purposes described above, or as required by organizational policies.</p>
            
            <h3>5. Your Rights</h3>
            <p>You have the right to:</p>
            <ul>
                <li>Access your personal data stored in the system.</li>
                <li>Request correction of inaccurate or outdated information.</li>
                <li>Request deletion of your data, subject to retention policies.</li>
                <li>Withdraw consent where applicable, which may affect your ability to use the System.</li>
            </ul>
            <p>To exercise any of these rights, please contact the system administrator at SmartSupport operators.</p>
            
            <h3>6. Data Security</h3>
            <p>We implement appropriate technical and organizational measures to:</p>
            <ul>
                <li>Protect your personal information against unauthorized access, alteration, or disclosure.</li>
                <li>Secure user accounts through authentication and access control.</li>
                <li>Regularly monitor system activity for suspicious behavior.</li>
            </ul>
            <p>However, no system is 100% secure, and you are also responsible for protecting your login credentials.</p>
            
            <h3>7. Cookies and Tracking Technologies</h3>
            <p>The System may use cookies or session-based tracking for authentication and performance analytics. You can manage cookie settings in your browser.</p>
            
            <h3>8. Updates to this Privacy Policy</h3>
            <p>We may update this policy from time to time. You will be notified of any significant changes, and continued use of the System after updates constitutes acceptance of the revised policy.</p>
            
            <h3>9. Contact Us</h3>
            <p>If you have any questions or concerns regarding this Privacy Policy, please contact: SmartSupport operators.</p>
        `;

        // Terms and Conditions content
        const termsAndConditionsContent = `
            <p>By accessing and using the SmartSupport: AI-Powered Helpdesk Ticketing System, you agree to comply with the following Terms and Conditions. Please read them carefully before submitting any support tickets.</p>
            
            <h3>1. Acceptance of Terms</h3>
            <p>By using this System, you acknowledge that you have read, understood, and agree to these Terms. If you do not accept any part of these terms, you must refrain from using the System.</p>
            
            <h3>2. Purpose of the System</h3>
            <p>This System is provided to help users (e.g., employees or authorized personnel) submit, track, and receive support for technical or administrative issues within the organization.</p>
            
            <h3>3. User Responsibilities</h3>
            <ul>
                <li>Provide accurate and complete information when submitting tickets.</li>
                <li>Use the System only for legitimate support requests.</li>
                <li>Avoid submitting duplicate, irrelevant, or fraudulent tickets.</li>
                <li>Respond to follow-up questions from support agents in a timely manner.</li>
                <li>Submit only appropriate and professional content.</li>
            </ul>
            
            <h3>4. Ticket Closure</h3>
            <ul>
                <li>Once a ticket is marked as resolved by the support team, you will no longer be able to send additional messages regarding that issue.</li>
                <li>If no action is taken by the user within the specified SLA timeline, the System will automatically close the ticket to maintain workflow efficiency and compliance with internal SLAs.</li>
                <li>Uncooperative behavior or lack of feedback may delay the closure of your ticket.</li>
            </ul>
            
            <h3>5. Account and Security</h3>
            <ul>
                <li>You are responsible for keeping your login credentials secure and confidential.</li>
                <li>Do not share your account with others or impersonate another user.</li>
                <li>Report any unauthorized access or suspicious activity to the system administrator immediately.</li>
            </ul>
            
            <h3>6. Prohibited Actions</h3>
            <ul>
                <li>You agree not to misuse the System or disrupt its normal operation.</li>
                <li>Do not upload or transmit harmful, offensive, or malicious content.</li>
                <li>Do not attempt to access restricted or administrative areas of the System.</li>
            </ul>
            
            <h3>7. System Availability and Maintenance</h3>
            <p>The System is provided on an "as-is" and "as-available" basis. While we strive to maintain accessible and functional systems, we do not guarantee that the System will be uninterrupted, secure, or free of errors.</p>
            <p>Scheduled maintenance or unexpected issues may temporarily affect system availability. We will make reasonable efforts to notify users in advance of any planned outages.</p>
            
            <h3>8. Limitation of Liability</h3>
            <p>To the fullest extent permitted by law, the organization and its affiliates are not liable for any indirect, incidental, special, or consequential damages arising out of or in connection with your use of the System.</p>
            
            <h3>9. Changes to Terms and Conditions</h3>
            <p>We may update these Terms and Conditions from time to time. You will be notified of any significant changes, and continued use of the System after updates constitutes acceptance of the revised terms.</p>
            
            <h3>10. Governing Law</h3>
            <p>These Terms and Conditions are governed by and construed in accordance with the laws of the jurisdiction in which the organization is located, without regard to its conflict of law principles.</p>
            
            <h3>11. Contact Information</h3>
            <p>For any questions or concerns regarding these Terms and Conditions, please contact: SmartSupport operators.</p>
        `;

        // Show modal - always starts with Privacy Policy
        function showModal(type) {
            const modal = document.getElementById('policyModal');
            currentStep = 'privacy';
            scrolledToBottom = false;
            updateModalContent();
            modal.style.display = 'flex';
        }

        // Update modal content based on current step
        function updateModalContent() {
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');
            const nextBtn = document.getElementById('nextBtn');
            const agreeBtn = document.getElementById('agreeBtn');
            const backBtn = document.getElementById('backBtn');

            // Reset scroll position and button state
            modalContent.scrollTop = 0;
            scrolledToBottom = false;

            if (currentStep === 'privacy') {
                modalTitle.textContent = 'Privacy Policy';
                modalContent.innerHTML = privacyPolicyContent;
                nextBtn.style.display = 'inline-flex';
                nextBtn.disabled = true;
                agreeBtn.style.display = 'none';
                backBtn.style.display = 'none';
            } else {
                modalTitle.textContent = 'Terms and Conditions';
                modalContent.innerHTML = termsAndConditionsContent;
                nextBtn.style.display = 'none';
                agreeBtn.style.display = 'inline-flex';
                agreeBtn.disabled = true;
                backBtn.style.display = 'inline-flex';
            }
        }

        // Handle scroll in modal content
        function handleModalScroll() {
            const modalContent = document.getElementById('modalContent');
            const atBottom = modalContent.scrollHeight - modalContent.scrollTop - modalContent.clientHeight < 10;
            
            if (atBottom && !scrolledToBottom) {
                scrolledToBottom = true;
                if (currentStep === 'privacy') {
                    document.getElementById('nextBtn').disabled = false;
                } else {
                    document.getElementById('agreeBtn').disabled = false;
                }
            }
        }

        // Go to next step (Terms)
        function goNextStep() {
            if (currentStep === 'privacy') {
                currentStep = 'terms';
                scrolledToBottom = false;
                updateModalContent();
            }
        }

        // Go back to Privacy Policy
        function goBackStep() {
            if (currentStep === 'terms') {
                currentStep = 'privacy';
                updateModalContent();
                // Enable Next button since user already read Privacy Policy
                setTimeout(() => {
                    const modalContent = document.getElementById('modalContent');
                    modalContent.scrollTop = modalContent.scrollHeight;
                    scrolledToBottom = true;
                    document.getElementById('nextBtn').disabled = false;
                }, 0);
            }
        }

        // Close modal
        function closeModal() {
            const modal = document.getElementById('policyModal');
            modal.style.display = 'none';
            currentStep = 'privacy';
            scrolledToBottom = false;
        }

        // Handle agree on modal
        function handleAgree() {
            const termsCheckbox = document.getElementById('termsCheckbox');
            termsCheckbox.checked = true;
            closeModal();
        }

        // Initialize on page load
        window.addEventListener('load', function() {
            if (typeof Cropper !== 'undefined') {
                console.log('Cropper.js loaded successfully');
            } else {
                console.error('Cropper.js failed to load');
            }

            // Restrict phone number input to digits only, max 11 characters
            const phoneField = document.querySelector('input[name="phone_number"]');
            if (phoneField) {
                phoneField.addEventListener('input', function(e) {
                    // Remove any non-digit characters
                    e.target.value = e.target.value.replace(/\D/g, '').slice(0, 11);
                });

                phoneField.addEventListener('paste', function(e) {
                    // Prevent pasting non-numeric content
                    e.preventDefault();
                    const pasted = (e.clipboardData || window.clipboardData).getData('text');
                    if (/^\d+$/.test(pasted)) {
                        e.target.value = pasted.slice(0, 11);
                    }
                });
            }

            // Restrict company_id input to digits only, max 4 characters
            const companyIdField = document.querySelector('input[name="company_id"]');
            if (companyIdField) {
                companyIdField.addEventListener('input', function(e) {
                    // Remove any non-digit characters
                    e.target.value = e.target.value.replace(/\D/g, '').slice(0, 4);
                });

                companyIdField.addEventListener('paste', function(e) {
                    // Prevent pasting non-numeric content
                    e.preventDefault();
                    const pasted = (e.clipboardData || window.clipboardData).getData('text');
                    if (/^\d+$/.test(pasted)) {
                        e.target.value = pasted.slice(0, 4);
                    }
                });
            }
        });
        
        document.getElementById('registerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const submitBtn = this.querySelector('.submit-button');
            
            // Show loading state
            submitBtn.disabled = true;
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>&nbsp;&nbsp;Creating Account...';
            
            // Get access token from cookies if available
            const accessToken = document.cookie.split('; ').find(row => row.startsWith('access_token='))?.split('=')[1];
            
            const fetchOptions = {
                method: 'POST',
                body: formData
            };
            
            // Add Authorization header if we have a token
            if (accessToken) {
                fetchOptions.headers = {
                    'Authorization': `Bearer ${accessToken}`
                };
            }
            
            fetch('/api/v1/hdts/employees/api/register/', fetchOptions)
            .then(response => {
                // Always try to parse as JSON, regardless of status
                return response.json().then(data => ({
                    status: response.status,
                    ok: response.ok,
                    data: data
                }));
            })
            .then(result => {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                
                const errorContainer = document.getElementById('errorContainer');
                const errorMessage = document.getElementById('errorMessage');
                
                if (result.ok && (result.data.success || result.data.id)) {
                    // Success
                    errorContainer.style.display = 'none';
                    alert('Account created successfully! Please log in with your credentials.');
                    window.location.href = '{% url "employee-login-shortcut" %}';
                } else {
                    // Handle errors - both 400 and other responses
                    let errorMsg = '';
                    const data = result.data;
                    
                    if (data.email) {
                        errorMsg = 'Invalid Email.';
                    } else if (data.username) {
                        errorMsg = 'Invalid Username.';
                    } else if (data.phone_number) {
                        errorMsg = 'Invalid Phone Number.';
                    } else if (data.password) {
                        errorMsg = 'Invalid Password.';
                    } else if (data.password2) {
                        errorMsg = 'Passwords do not match.';
                    } else if (data.department) {
                        errorMsg = 'Invalid Department.';
                    } else if (data.error) {
                        errorMsg = data.error;
                    } else if (data.detail) {
                        errorMsg = data.detail;
                    } else {
                        errorMsg = 'Registration failed. Please try again.';
                    }
                    
                    console.log('Registration error:', data);
                    errorMessage.textContent = errorMsg;
                    errorContainer.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                
                const errorContainer = document.getElementById('errorContainer');
                const errorMessage = document.getElementById('errorMessage');
                errorMessage.textContent = 'An error occurred during registration. Please try again.';
                errorContainer.style.display = 'block';
            });
        });
    </script>

</body>
</html>
