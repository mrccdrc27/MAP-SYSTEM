{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile Settings</title>
    <link rel="stylesheet" href="{% static 'css/profile_settings.css' %}">
</head>
<body>
    <main class="manageProfilePage">
        <div class="manageProfileContainer">
            <h1>Manage Profile</h1>

            {% if messages %}
                <div class="toastContainer">
                    {% for message in messages %}
                        <div class="toast {% if message.tags %}{{ message.tags }}{% endif %}">
                            {{ message }}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}

            <form method="post" enctype="multipart/form-data" id="profile-form">
                {% csrf_token %}

                <div class="profileContent">
                    <div class="profileLeft">
                        <div class="profileCard">
                <div class="profileImageSection">
                  <div class="profileImageMenu hidden">
                    <button
                      type="button"
                      class="profileMenuBtn"
                      id="view-photo-btn"
                    >
                      View
                    </button>
                    <label
                      for="id_profile_picture"
                      class="profileMenuBtn changeImageBtn"
                      >Edit</label
                    >
                    {% if user.profile_picture %}
                    <div class="removePhotoOption">
                      <input
                        type="checkbox"
                        name="profile_picture-clear"
                        id="profile_picture-clear_id"
                      />
                      <label for="profile_picture-clear_id">Remove</label>
                    </div>
                    {% endif %}
                  </div>
                  <div class="profileImageContainer">
                    <img
                      id="profile-preview"
                      src="{% if user.profile_picture %}{{ user.profile_picture.url }}{% else %}https://i.pinimg.com/1200x/a9/a8/c8/a9a8c8258957c8c7d6fcd320e9973203.jpg{% endif %}"
                      alt="Profile"
                      class="profileImage"
                    />

                    <!-- Camera Icon Overlay -->
                    <div class="profileImageOverlay">
                      <i class="fa fa-camera"></i>
                    </div>
                  </div>

                  <p id="unsaved-warning" class="unsavedWarning hidden">
                    ‚ö†Ô∏è Changes not saved yet
                  </p>

                  <div class="formGroup formGroupFile hidden">
                    {{ form.profile_picture.errors }} {{ form.profile_picture }}
                  </div>
                </div>

                <div class="profileInfo">
                  <h3>{% if user.first_name or user.last_name %}{{ user.first_name }} {{ user.last_name }}{% else %}{{ user.username }}{% endif %}</h3>
                  <div class="profileInfoContainer">
                    <p><strong>Username:</strong></p>
                    <span>{{ user.username }}</span>
                  </div>
                  <div class="profileInfoContainer">
                    <p><strong>Email:</strong></p>
                    <span>{{ user.email }}</span>
                  </div>
                  <div class="profileInfoContainer">
                    <p><strong>Company ID:</strong></p>
                    <span>{{ user.company_id|default:'N/A'}}</span>
                  </div>
                  <div class="profileInfoContainer">
                    <p><strong>Department:</strong></p>
                    <span>{{ user.get_department_display|default:'N/A'}}</span>
                  </div>
                </div>

                <div class="quickLinksCard">
                  <h3>Quick Links</h3>
                  <div id="admin-links">
                    <a href="{% url 'agent-management' %}" class="linkItem1"
                      >Manage Agents</a
                    >
                  </div>
                   <div id="admin-links">
                    <a href="{% url 'change-password-ui' %}" class="linkItem1"
                      >Change Password</a
                    >
                  </div>
                  {% comment %} <a href="{% url 'cookie-logout' %}" class="linkItem2"
                    >Logout</a
                  > {% endcomment %}
                  <a href="{% url 'root_logout' %}" class="linkItem2"
                    >Logout</a
                  >
                </div>
                        </div>
                    </div>

                    <div class="profileRight">
                        <div class="profileSettingsCard">
                            
                            <h2>Personal Details</h2>
                            <div class="formGrid">
                                <div class="formGroup">
                                    {{ form.first_name.label_tag }}
                                    {{ form.first_name.errors }}
                                    {{ form.first_name }}
                                </div>
                                <div class="formGroup">
                                    {{ form.middle_name.label_tag }}
                                    {{ form.middle_name.errors }}
                                    {{ form.middle_name }}
                                </div>
                                <div class="formGroup">
                                    {{ form.last_name.label_tag }}
                                    {{ form.last_name.errors }}
                                    {{ form.last_name }}
                                </div>
                                <div class="formGroup">
                                    {{ form.suffix.label_tag }}
                                    {{ form.suffix.errors }}
                                    {{ form.suffix }}
                                </div>
                                <div class="formGroup">
                                    {{ form.username.label_tag }}
                                    {{ form.username.errors }}
                                    {{ form.username }}
                                </div>
                                <div class="formGroup">
                                    {{ form.phone_number.label_tag }}
                                    {{ form.phone_number.errors }}
                                    {{ form.phone_number }}
                                </div>
                            </div>

                            <h2>Organization</h2>
                            <div class="formGrid">
                                <div class="formGroup">
                                    {{ form.email.label_tag }}
                                    {{ form.email.errors }}
                                    {{ form.email }}
                                    <small>{{ form.email.help_text }}</small>
                                </div>
                                <div class="formGroup">
                                    {{ form.company_id.label_tag }}
                                    {{ form.company_id.errors }}
                                    {{ form.company_id }}
                                    <small>{{ form.company_id.help_text }}</small>
                                </div>
                                <div class="formGroup">
                                    {{ form.department.label_tag }}
                                    {{ form.department.errors }}
                                    {{ form.department }}
                                </div>
                            </div>

                            <h2>Account & Security</h2>
                            <div class="formGrid">
                                <div class="formGroup formGroupCheckbox">
                                    {{ form.otp_enabled.errors }}
                                    {{ form.otp_enabled }}
                                    {{ form.otp_enabled.label_tag }}
                                </div>
                                <div class="formGroup">
                                    {{ form.last_login.label_tag }}
                                    {{ form.last_login.errors }}
                                    {{ form.last_login }}
                                    <small>{{ form.last_login.help_text }}</small>
                                </div>
                                <div class="formGroup">
                                    {{ form.date_joined.label_tag }}
                                    {{ form.date_joined.errors }}
                                    {{ form.date_joined }}
                                    <small>{{ form.date_joined.help_text }}</small>
                                </div>
                            </div>

                            {% comment %} {% if user.is_superuser or user.is_staff %}
                                <h2>Admin Information</h2>
                                <div class="formGrid">
                                    <div class="formGroup">
                                        {{ form.status.label_tag }}
                                        {{ form.status.errors }}
                                        {{ form.status }}
                                    </div>
                                    <div class="formGroup">
                                        {{ form.failed_login_attempts.label_tag }}
                                        {{ form.failed_login_attempts.errors }}
                                        {{ form.failed_login_attempts }}
                                        <small>{{ form.failed_login_attempts.help_text }}</small>
                                    </div>
                                    <div class="formGroup">
                                        {{ form.lockout_time.label_tag }}
                                        {{ form.lockout_time.errors }}
                                        {{ form.lockout_time }}
                                        <small>{{ form.lockout_time.help_text }}</small>
                                    </div>
                                </div>
                                <div class="formGrid formGridCheckboxes">
                                    <div class="formGroup formGroupCheckbox">
                                        {{ form.notified.errors }}
                                        {{ form.notified }}
                                        {{ form.notified.label_tag }}
                                    </div>
                                    <div class="formGroup formGroupCheckbox">
                                        {{ form.is_active.errors }}
                                        {{ form.is_active }}
                                        {{ form.is_active.label_tag }}
                                    </div>
                                    <div class="formGroup formGroupCheckbox">
                                        {{ form.is_staff.errors }}
                                        {{ form.is_staff }}
                                        {{ form.is_staff.label_tag }}
                                    </div>
                                    <div class="formGroup formGroupCheckbox">
                                        {{ form.is_superuser.errors }}
                                        {{ form.is_superuser }}
                                        {{ form.is_superuser.label_tag }}
                                    </div>
                                    <div class="formGroup formGroupCheckbox">
                                        {{ form.is_locked.errors }}
                                        {{ form.is_locked }}
                                        {{ form.is_locked.label_tag }}
                                    </div>
                                </div>
                            {% endif %} {% endcomment %}
                            
                            <div class="formActions">
                                <button type="button" id="edit-profile-btn" class="editChangesBtn">EDIT PROFILE</button>
                                <button type="submit" id="save-changes-btn" class="saveChangesBtn hidden">SAVE CHANGES</button>
                                <button type="button" id="cancel-changes-btn" class="cancelChangesBtn hidden">CANCEL</button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </main>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const profileForm = document.getElementById("profile-form");
        if (!profileForm) return;

        // Get user admin status from template
        const isAdmin = {% if user.is_superuser or user.is_staff %}true{% else %}false{% endif %};

        const formInputs = profileForm.querySelectorAll(
          ".profileSettingsCard input, .profileSettingsCard select"
        );

        const editBtn = document.getElementById("edit-profile-btn");
        const saveBtn = document.getElementById("save-changes-btn");
        const cancelBtn = document.getElementById("cancel-changes-btn");

        const profilePicInput = document.getElementById("id_profile_picture");
        const profilePicLabel = document.querySelector("label.changeImageBtn");
        const removePicCheckbox = document.getElementById(
          "profile_picture-clear_id"
        );
        const removePicLabel = document.querySelector(
          'label[for="profile_picture-clear_id"]'
        );

        const preview = document.getElementById("profile-preview");
        const unsaved = document.getElementById("unsaved-warning");
        const originalImageSrc = preview.src;

        // Fields that are always read-only (non-editable by anyone)
        const permanentReadOnlyIds = [
          "id_last_login",
          "id_date_joined",
          "id_failed_login_attempts",
          "id_lockout_time",
        ];

        // Fields that only admins can edit (restricted for regular users)
        const adminOnlyIds = [
          "id_first_name",
          "id_middle_name",
          "id_last_name",
          "id_suffix",
          "id_email",
          "id_company_id",
          "id_department",
        ];

        function setFormEnabled(enabled) {
          formInputs.forEach((input) => {
            if (!input) return;
            if (input.type === "button" || input.type === "submit") return;
            
            // Always keep these read-only
            if (permanentReadOnlyIds.includes(input.id)) {
              input.readOnly = true;
              if (input.tagName.toLowerCase() === "select") {
                input.disabled = true;
              }
              return;
            }

            // For non-admin users, keep admin-only fields disabled
            if (!isAdmin && adminOnlyIds.includes(input.id)) {
              if (input.tagName.toLowerCase() === "select" || input.type === "checkbox") {
                input.disabled = true;
              } else {
                input.readOnly = true;
              }
              return;
            }

            // For all other fields, enable/disable based on edit mode
            if (
              input.tagName.toLowerCase() === "select" ||
              input.type === "checkbox"
            ) {
              input.disabled = !enabled;
            } else {
              input.readOnly = !enabled;
            }
          });

          if (profilePicInput) profilePicInput.disabled = !enabled;
          if (profilePicLabel) {
            profilePicLabel.style.pointerEvents = enabled ? "auto" : "none";
            profilePicLabel.style.opacity = enabled ? "1" : "0.6";
          }
          if (removePicCheckbox) removePicCheckbox.disabled = !enabled;
          if (removePicLabel) {
            removePicLabel.style.pointerEvents = enabled ? "auto" : "none";
            removePicLabel.style.opacity = enabled ? "1" : "0.6";
          }

          if (editBtn) editBtn.classList.toggle("hidden", enabled);
          if (saveBtn) saveBtn.classList.toggle("hidden", !enabled);
          if (cancelBtn) cancelBtn.classList.toggle("hidden", !enabled);
        }

        if (editBtn) {
          editBtn.addEventListener("click", () => setFormEnabled(true));
        }

        if (cancelBtn) {
          cancelBtn.addEventListener("click", () => {
            profileForm.reset();
            preview.src = originalImageSrc;
            unsaved.classList.add("hidden");
            setFormEnabled(false);
          });
        }

        // Handle form submission - ensure disabled fields don't get submitted
        if (profileForm) {
          profileForm.addEventListener("submit", function(e) {
            console.log("Form submitting. User is admin:", isAdmin);
            
            // For non-admin users, disable ALL restricted fields before submission
            // Disabled fields are not included in form submission
            if (!isAdmin) {
              console.log("Non-admin user - disabling restricted fields:", adminOnlyIds);
              adminOnlyIds.forEach((fieldId) => {
                const field = document.getElementById(fieldId);
                if (field) {
                  console.log("Disabling field:", fieldId, "current value:", field.value);
                  // Disable the field so it won't be submitted
                  field.disabled = true;
                  // Also remove readonly to ensure it's truly disabled
                  field.readOnly = false;
                }
              });
              
              // Log what fields will be submitted
              const formData = new FormData(profileForm);
              console.log("Fields being submitted:");
              for (let [key, value] of formData.entries()) {
                console.log("  ", key, ":", value);
              }
            }
          });
        }

        if (profilePicInput) {
          profilePicInput.addEventListener("change", function () {
            const file = this.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = function (e) {
                preview.src = e.target.result;
                unsaved.classList.remove("hidden");
              };
              reader.readAsDataURL(file);
            }
          });
        }

        const toasts = document.querySelectorAll(".toast");
        toasts.forEach((toast) =>
          setTimeout(() => toast.classList.add("hide"), 3500)
        );

        // Hide file input, keep label clickable
        if (profilePicInput && profilePicLabel) {
          if (profilePicLabel.nextSibling !== profilePicInput) {
            profilePicLabel.parentNode.insertBefore(
              profilePicInput,
              profilePicLabel.nextSibling
            );
          }
          profilePicInput.classList.add("fileInputHidden");
        }

        setFormEnabled(false);
        checkAdminPrivileges();

        // Add visual indicators for restricted fields (non-admin users)
        if (!isAdmin) {
          adminOnlyIds.forEach((fieldId) => {
            const field = document.getElementById(fieldId);
            if (field) {
              const formGroup = field.closest(".formGroup");
              if (formGroup) {
                // Check if help text already exists
                let helpText = formGroup.querySelector("small.admin-only-notice");
                if (!helpText) {
                  helpText = document.createElement("small");
                  helpText.className = "admin-only-notice";
                  helpText.style.color = "#999";
                  helpText.style.fontSize = "12px";
                  helpText.style.marginTop = "4px";
                  helpText.textContent = "Only administrators can edit this field.";
                  formGroup.appendChild(helpText);
                }
              }
            }
          });
        }

        // --- Profile Image Overlay Menu ---
        const container = document.querySelector(".profileImageContainer");
        const menu = document.querySelector(".profileImageMenu");
        const viewBtn = document.getElementById("view-photo-btn");

        if (container && menu && preview) {
          container.addEventListener("click", (e) => {
            e.stopPropagation();
            menu.classList.toggle("hidden");
          });

          document.addEventListener("click", () =>
            menu.classList.add("hidden")
          );

          if (viewBtn) {
            viewBtn.addEventListener("click", (e) => {
              e.stopPropagation();
              window.open(preview.src, "_blank");
              menu.classList.add("hidden");
            });
          }
        }

        // --- Admin Privileges ---
        function getCookie(name) {
          let cookieValue = null;
          if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let cookie of cookies) {
              cookie = cookie.trim();
              if (cookie.startsWith(name + "=")) {
                cookieValue = decodeURIComponent(
                  cookie.substring(name.length + 1)
                );
                break;
              }
            }
          }
          return cookieValue;
        }

        async function checkAdminPrivileges() {
          try {
            const csrfToken = getCookie("csrftoken");
            const response = await fetch("/api/v1/users/list/", {
              method: "GET",
              headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrfToken,
              },
              credentials: "include",
            });
            if (response.ok) {
              document.getElementById("admin-links").style.display = "block";
            }
          } catch {
            console.log("User does not have admin privileges");
          }
        }
      });
    </script>

    <!-- Modal for OTP Disable Verification -->
    <div id="disable-otp-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Disable Two-Factor Authentication</h3>
                <button type="button" class="modal-close" id="modal-close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 20px; color: #666;">
                    For security purposes, please verify your identity before disabling 2FA.
                </p>
                <div id="otp-request-info" class="info-message" style="background: #e3f2fd; padding: 10px; border-radius: 4px; margin-bottom: 15px;">
                    <p style="margin: 0; color: #1976d2; font-size: 14px;">
                        üìß An OTP code has been sent to your email. Please check your inbox.
                    </p>
                </div>
                <div class="formGroup">
                    <label for="verify-password">Password</label>
                    <input type="password" id="verify-password" class="form-control" placeholder="Enter your password" required>
                    <small class="error-message" id="password-error"></small>
                </div>
                <div class="formGroup">
                    <label for="verify-otp">OTP Code</label>
                    <input type="text" id="verify-otp" class="form-control" placeholder="Enter your OTP code" maxlength="6" required>
                    <small class="error-message" id="otp-error"></small>
                    <small style="color: #666;">Enter the 6-digit code sent to your email.</small>
                </div>
                <div id="verification-general-error" class="error-message" style="margin-top: 10px;"></div>
                <div style="margin-top: 15px;">
                    <button type="button" id="resend-otp-btn" class="resend-otp-btn" style="background: none; border: none; color: #1976d2; cursor: pointer; text-decoration: underline; font-size: 14px;">
                        Didn't receive the code? Resend OTP
                    </button>
                    <span id="resend-timer" style="color: #666; font-size: 14px; margin-left: 10px; display: none;"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="cancelChangesBtn" id="modal-cancel-btn">Cancel</button>
                <button type="button" class="saveChangesBtn" id="modal-verify-btn">Verify & Disable</button>
            </div>
        </div>
    </div>

    <style>
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 20px;
            color: #333;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            line-height: 1;
        }

        .modal-close:hover {
            color: #333;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .error-message {
            display: block;
            color: #d32f2f;
            font-size: 12px;
            margin-top: 5px;
        }

        .error-message:empty {
            display: none;
        }

        .info-message {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .info-message p {
            margin: 0;
            color: #1976d2;
            font-size: 14px;
        }

        .resend-otp-btn {
            background: none;
            border: none;
            color: #1976d2;
            cursor: pointer;
            text-decoration: underline;
            font-size: 14px;
            padding: 0;
        }

        .resend-otp-btn:hover:not(:disabled) {
            color: #1565c0;
        }

        .resend-otp-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>

    <script>
        // OTP Disable Verification Modal Handler
        document.addEventListener("DOMContentLoaded", function () {
            const otpCheckbox = document.getElementById("id_otp_enabled");
            const modal = document.getElementById("disable-otp-modal");
            const modalCloseBtn = document.getElementById("modal-close-btn");
            const modalCancelBtn = document.getElementById("modal-cancel-btn");
            const modalVerifyBtn = document.getElementById("modal-verify-btn");
            const verifyPasswordInput = document.getElementById("verify-password");
            const verifyOtpInput = document.getElementById("verify-otp");
            const passwordError = document.getElementById("password-error");
            const otpError = document.getElementById("otp-error");
            const generalError = document.getElementById("verification-general-error");
            const resendOtpBtn = document.getElementById("resend-otp-btn");
            const resendTimer = document.getElementById("resend-timer");
            const otpRequestInfo = document.getElementById("otp-request-info");

            let originalOtpState = otpCheckbox ? otpCheckbox.checked : false;
            let isVerificationPending = false;
            let resendCooldown = 0;
            let resendInterval = null;

            // Track original state when page loads
            if (otpCheckbox) {
                originalOtpState = otpCheckbox.checked;
            }

            // Function to request OTP
            async function requestOTP() {
                try {
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                    const response = await fetch("/api/v1/users/2fa/request-otp-authenticated/", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": csrfToken,
                        },
                        credentials: "include",
                        body: JSON.stringify({})
                    });

                    const data = await response.json();

                    if (response.ok) {
                        otpRequestInfo.style.display = "block";
                        otpRequestInfo.innerHTML = '<p style="margin: 0; color: #1976d2; font-size: 14px;">‚úÖ OTP code sent successfully! Check your email.</p>';
                        
                        // Start resend cooldown
                        startResendCooldown();
                    } else {
                        otpRequestInfo.style.display = "block";
                        otpRequestInfo.style.background = "#ffebee";
                        otpRequestInfo.innerHTML = '<p style="margin: 0; color: #c62828; font-size: 14px;">‚ö†Ô∏è Failed to send OTP. Please try again.</p>';
                    }
                } catch (error) {
                    console.error("Error requesting OTP:", error);
                    otpRequestInfo.style.display = "block";
                    otpRequestInfo.style.background = "#ffebee";
                    otpRequestInfo.innerHTML = '<p style="margin: 0; color: #c62828; font-size: 14px;">‚ö†Ô∏è Network error. Please try again.</p>';
                }
            }

            // Start resend cooldown timer
            function startResendCooldown() {
                resendCooldown = 60; // 60 seconds cooldown
                resendOtpBtn.disabled = true;
                resendOtpBtn.style.opacity = "0.5";
                resendOtpBtn.style.cursor = "not-allowed";
                resendTimer.style.display = "inline";
                
                if (resendInterval) clearInterval(resendInterval);
                
                resendInterval = setInterval(() => {
                    resendCooldown--;
                    resendTimer.textContent = `(Wait ${resendCooldown}s)`;
                    
                    if (resendCooldown <= 0) {
                        clearInterval(resendInterval);
                        resendOtpBtn.disabled = false;
                        resendOtpBtn.style.opacity = "1";
                        resendOtpBtn.style.cursor = "pointer";
                        resendTimer.style.display = "none";
                    }
                }, 1000);
            }

            // Resend OTP button handler
            if (resendOtpBtn) {
                resendOtpBtn.addEventListener("click", async function() {
                    if (resendCooldown > 0) return;
                    await requestOTP();
                });
            }

            // Intercept OTP checkbox changes
            if (otpCheckbox) {
                otpCheckbox.addEventListener("change", async function(e) {
                    // If OTP is being disabled (was checked, now unchecked)
                    if (originalOtpState && !this.checked) {
                        e.preventDefault();
                        this.checked = true; // Keep it checked
                        isVerificationPending = true;
                        
                        // Clear previous errors and inputs
                        passwordError.textContent = "";
                        otpError.textContent = "";
                        generalError.textContent = "";
                        verifyPasswordInput.value = "";
                        verifyOtpInput.value = "";
                        otpRequestInfo.style.display = "none";
                        otpRequestInfo.style.background = "#e3f2fd";
                        
                        // Show modal
                        modal.style.display = "flex";
                        
                        // Automatically request OTP when modal opens
                        await requestOTP();
                        
                        verifyPasswordInput.focus();
                    } else if (!originalOtpState && this.checked) {
                        // Enabling OTP - allow it normally
                        isVerificationPending = false;
                    }
                });
            }

            // Close modal handlers
            function closeModal() {
                modal.style.display = "none";
                isVerificationPending = false;
                if (otpCheckbox) {
                    otpCheckbox.checked = true; // Reset to checked state
                }
                // Clear cooldown timer
                if (resendInterval) {
                    clearInterval(resendInterval);
                    resendInterval = null;
                }
                resendCooldown = 0;
                resendTimer.style.display = "none";
                resendOtpBtn.disabled = false;
                resendOtpBtn.style.opacity = "1";
                resendOtpBtn.style.cursor = "pointer";
            }

            if (modalCloseBtn) {
                modalCloseBtn.addEventListener("click", closeModal);
            }

            if (modalCancelBtn) {
                modalCancelBtn.addEventListener("click", closeModal);
            }

            // Click outside modal to close
            modal.addEventListener("click", function(e) {
                if (e.target === modal) {
                    closeModal();
                }
            });

            // Verify and disable OTP
            if (modalVerifyBtn) {
                modalVerifyBtn.addEventListener("click", async function() {
                    const password = verifyPasswordInput.value.trim();
                    const otp = verifyOtpInput.value.trim();

                    // Clear previous errors
                    passwordError.textContent = "";
                    otpError.textContent = "";
                    generalError.textContent = "";

                    // Validate inputs
                    let hasError = false;
                    if (!password) {
                        passwordError.textContent = "Password is required";
                        hasError = true;
                    }
                    if (!otp) {
                        otpError.textContent = "OTP code is required";
                        hasError = true;
                    }
                    if (otp && otp.length !== 6) {
                        otpError.textContent = "OTP must be 6 digits";
                        hasError = true;
                    }

                    if (hasError) return;

                    // Disable button during request
                    modalVerifyBtn.disabled = true;
                    modalVerifyBtn.textContent = "Verifying...";

                    try {
                        // Get CSRF token
                        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

                        // Send verification request
                        const response = await fetch("/api/v1/users/verify-disable-otp/", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                "X-CSRFToken": csrfToken,
                            },
                            credentials: "include",
                            body: JSON.stringify({
                                password: password,
                                otp_code: otp
                            })
                        });

                        const data = await response.json();

                        if (response.ok) {
                            // Verification successful - allow OTP to be disabled
                            originalOtpState = false;
                            if (otpCheckbox) {
                                otpCheckbox.checked = false;
                            }
                            isVerificationPending = false;
                            closeModal();
                            
                            // Show success message
                            const toastContainer = document.querySelector(".toastContainer");
                            if (toastContainer) {
                                const toast = document.createElement("div");
                                toast.className = "toast success";
                                toast.textContent = "Verification successful. You can now save your changes.";
                                toastContainer.appendChild(toast);
                                setTimeout(() => toast.classList.add("hide"), 3500);
                            }
                        } else {
                            // Show error
                            if (data.password) {
                                passwordError.textContent = Array.isArray(data.password) ? data.password.join(", ") : data.password;
                            }
                            if (data.otp_code) {
                                otpError.textContent = Array.isArray(data.otp_code) ? data.otp_code.join(", ") : data.otp_code;
                            }
                            if (data.detail || data.error) {
                                generalError.textContent = data.detail || data.error;
                            }
                            if (data.non_field_errors) {
                                generalError.textContent = Array.isArray(data.non_field_errors) ? data.non_field_errors.join(", ") : data.non_field_errors;
                            }
                            if (!data.password && !data.otp_code && !data.detail && !data.error && !data.non_field_errors) {
                                generalError.textContent = "Verification failed. Please check your credentials.";
                            }
                        }
                    } catch (error) {
                        console.error("Verification error:", error);
                        generalError.textContent = "An error occurred. Please try again.";
                    } finally {
                        // Re-enable button
                        modalVerifyBtn.disabled = false;
                        modalVerifyBtn.textContent = "Verify & Disable";
                    }
                });
            }

            // Handle Enter key in inputs
            [verifyPasswordInput, verifyOtpInput].forEach(input => {
                if (input) {
                    input.addEventListener("keypress", function(e) {
                        if (e.key === "Enter") {
                            e.preventDefault();
                            modalVerifyBtn.click();
                        }
                    });
                }
            });
        });
    </script>
    </body>
</html>