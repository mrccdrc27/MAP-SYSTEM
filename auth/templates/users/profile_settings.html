{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile Settings</title>
    <link rel="stylesheet" href="{% static 'css/profile_settings.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>
<body>
    {% include "components/nav.html" %}
    {% include "components/toast_notification.html" %}

    <main class="manageProfilePage">
        <div class="manageProfileContainer">
            <div class="header">
                <h2>Manage Profile</h2>
            </div>

            <!-- Loading State -->
            <div id="loading-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999; justify-content: center; align-items: center;">
                <div class="spinner" style="border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;"></div>
                <style>@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>
            </div>

            <form id="profile-form" onsubmit="return false;">
                {% csrf_token %}

                <div class="profileContent">
                    <div class="profileLeft">
                        <div class="profileCard">
                            <div class="profileImageSection">
                                <div class="profileImageMenu hidden">
                                    <button type="button" class="profileMenuBtn" id="view-photo-btn">View</button>
                                    <label for="id_profile_picture" class="profileMenuBtn changeImageBtn">Edit</label>
                                    <div class="removePhotoOption" id="remove-photo-container" style="display: none;">
                                        <input type="checkbox" name="profile_picture-clear" id="profile_picture-clear_id" />
                                        <label for="profile_picture-clear_id">Remove</label>
                                    </div>
                                </div>
                                <div class="profileImageContainer">
                                    <img id="profile-preview" src="https://i.pinimg.com/1200x/a9/a8/c8/a9a8c8258957c8c7d6fcd320e9973203.jpg" alt="Profile" class="profileImage" />
                                    <!-- Camera Icon Overlay -->
                                    <div class="profileImageOverlay">
                                        <i class="fa fa-camera"></i>
                                    </div>
                                </div>

                                <p id="unsaved-warning" class="unsavedWarning hidden">
                                    ⚠️ Changes not saved yet
                                </p>

                                <div class="formGroup formGroupFile hidden">
                                    <input type="file" id="id_profile_picture" name="profile_picture" accept="image/*">
                                </div>

                                <div class="profileInfo">
                                    <h3 id="display-full-name">Loading...</h3>
                                    <div class="profileInfoContainer">
                                        <p><strong>Username:</strong></p>
                                        <span id="display-username">-</span>
                                    </div>
                                    <div class="profileInfoContainer">
                                        <p><strong>Email:</strong></p>
                                        <span id="display-email">-</span>
                                    </div>
                                    <div class="profileInfoContainer">
                                        <p><strong>Company ID:</strong></p>
                                        <span id="display-company-id">-</span>
                                    </div>
                                    <div class="profileInfoContainer">
                                        <p><strong>Department:</strong></p>
                                        <span id="display-department">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="profileRight">
                        <div class="profileSettingsCard">
                            
                            <h2>Personal Details</h2>
                            <div class="formGrid">
                                <div class="formGroup">
                                    <label for="id_first_name">First Name</label>
                                    <input type="text" name="first_name" id="id_first_name" maxlength="100">
                                </div>
                                <div class="formGroup">
                                    <label for="id_middle_name">Middle Name</label>
                                    <input type="text" name="middle_name" id="id_middle_name" maxlength="100">
                                </div>
                                <div class="formGroup">
                                    <label for="id_last_name">Last Name</label>
                                    <input type="text" name="last_name" id="id_last_name" maxlength="100">
                                </div>
                                <div class="formGroup">
                                    <label for="id_suffix">Suffix</label>
                                    <input type="text" name="suffix" id="id_suffix" maxlength="10">
                                </div>
                                <div class="formGroup">
                                    <label for="id_username">Username</label>
                                    <input type="text" name="username" id="id_username" maxlength="150" required>
                                </div>
                                <div class="formGroup">
                                    {% include "components/phone_input.html" with field_id="id_phone_number" field_name="phone_number" default_country="+63" show_label=True label_text="Phone Number" %}
                                </div>
                            </div>

                            <h2>Organization</h2>
                            <div class="formGrid">
                                <div class="formGroup">
                                    <label for="id_email">Email</label>
                                    <input type="email" name="email" id="id_email" readonly disabled style="background-color: #f5f5f5; cursor: not-allowed;">
                                    <small>Email cannot be changed directly.</small>
                                </div>
                                <div class="formGroup">
                                    <label for="id_company_id">Company ID</label>
                                    <input type="text" name="company_id" id="id_company_id" readonly disabled style="background-color: #f5f5f5; cursor: not-allowed;">
                                </div>
                                <div class="formGroup">
                                    <label for="id_department">Department</label>
                                    <input type="text" name="department" id="id_department" readonly disabled style="background-color: #f5f5f5; cursor: not-allowed;">
                                </div>
                            </div>

                            <h2>Account & Security</h2>
                            <div class="formGrid">
                                <div class="formGroup formGroupCheckbox">
                                    <input type="checkbox" name="otp_enabled" id="id_otp_enabled">
                                    <label for="id_otp_enabled">Two-Factor Authentication</label>
                                </div>
                                <div class="formGroup">
                                    <label>Last Login</label>
                                    <input type="text" id="id_last_login" readonly disabled style="background-color: #f5f5f5;">
                                </div>
                                <div class="formGroup">
                                    <label>Date Joined</label>
                                    <input type="text" id="id_date_joined" readonly disabled style="background-color: #f5f5f5;">
                                </div>
                            </div>
                            
                            <div class="formActions">
                                <button type="button" id="edit-profile-btn" class="editChangesBtn">EDIT PROFILE</button>
                                <button type="button" id="save-changes-btn" class="saveChangesBtn hidden">SAVE CHANGES</button>
                                <button type="button" id="cancel-changes-btn" class="cancelChangesBtn hidden">CANCEL</button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </main>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const API_URL = '/api/v1/users/profile/';
            const profileForm = document.getElementById("profile-form");
            const loadingOverlay = document.getElementById("loading-overlay");
            
            // Buttons
            const editBtn = document.getElementById("edit-profile-btn");
            const saveBtn = document.getElementById("save-changes-btn");
            const cancelBtn = document.getElementById("cancel-changes-btn");
            
            // Fields
            const inputs = profileForm.querySelectorAll('input:not([type="hidden"]):not([type="file"])');
            const profilePicInput = document.getElementById("id_profile_picture");
            const preview = document.getElementById("profile-preview");
            const unsaved = document.getElementById("unsaved-warning");
            
            let initialData = {};
            let isAdmin = false; // Will be determined by API response if possible, or assumed false for safety

            // --- 1. Fetch Data ---
            async function fetchProfileData() {
                showLoading(true);
                try {
                    const response = await fetch(API_URL, {
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        }
                    });
                    
                    if (!response.ok) throw new Error('Failed to load profile data');
                    
                    const data = await response.json();
                    initialData = data;
                    populateForm(data);
                    
                } catch (error) {
                    console.error('Error:', error);
                    ToastNotification.error('Error', 'Could not load profile data.');
                } finally {
                    showLoading(false);
                }
            }

            function populateForm(data) {
                // Populate Display Section
                const fullName = [data.first_name, data.last_name].filter(Boolean).join(' ') || data.username;
                document.getElementById('display-full-name').textContent = fullName;
                document.getElementById('display-username').textContent = data.username || '-';
                document.getElementById('display-email').textContent = data.email || '-';
                document.getElementById('display-company-id').textContent = data.company_id || '-';
                document.getElementById('display-department').textContent = data.department || '-';
                
                if (data.profile_picture) {
                    preview.src = data.profile_picture;
                    document.getElementById('remove-photo-container').style.display = 'flex';
                }

                // Populate Inputs
                setValue('id_first_name', data.first_name);
                setValue('id_middle_name', data.middle_name);
                setValue('id_last_name', data.last_name);
                setValue('id_suffix', data.suffix);
                setValue('id_username', data.username);
                setValue('id_phone_number', data.phone_number);
                setValue('id_email', data.email);
                setValue('id_company_id', data.company_id);
                setValue('id_department', data.department);
                
                // Checkboxes
                if (document.getElementById('id_otp_enabled')) {
                    document.getElementById('id_otp_enabled').checked = data.otp_enabled;
                }

                // Read-only info
                setValue('id_last_login', formatDate(data.last_login));
                setValue('id_date_joined', formatDate(data.date_joined));
            }

            function setValue(id, value) {
                const el = document.getElementById(id);
                if (el) el.value = value || '';
            }

            function formatDate(isoString) {
                if (!isoString) return '-';
                return new Date(isoString).toLocaleString();
            }

            // --- 2. Edit Mode Toggle ---
            function setEditMode(enabled) {
                // Fields that are always allowed to be edited by user
                const editableIds = [
                    'id_first_name', 'id_middle_name', 'id_last_name', 'id_suffix',
                    'id_username', 'id_phone_number', 'id_otp_enabled'
                ];

                inputs.forEach(input => {
                    if (editableIds.includes(input.id)) {
                        input.readOnly = !enabled;
                        input.disabled = !enabled && input.type !== 'text'; // Checkboxes need disabled
                        if (input.type === 'checkbox') input.disabled = !enabled;
                    }
                });

                // Profile picture handling
                if (profilePicInput) profilePicInput.disabled = !enabled;
                const changeLabel = document.querySelector('.changeImageBtn');
                if (changeLabel) changeLabel.style.pointerEvents = enabled ? 'auto' : 'none';

                // Buttons visibility
                editBtn.classList.toggle('hidden', enabled);
                saveBtn.classList.toggle('hidden', !enabled);
                cancelBtn.classList.toggle('hidden', !enabled);
            }

            editBtn.addEventListener('click', () => setEditMode(true));
            
            cancelBtn.addEventListener('click', () => {
                setEditMode(false);
                populateForm(initialData); // Reset changes
                unsaved.classList.add('hidden');
            });

            // --- 3. Form Submission ---
            saveBtn.addEventListener('click', async () => {
                showLoading(true);
                
                const formData = new FormData();
                
                // Add text fields
                formData.append('first_name', document.getElementById('id_first_name').value);
                formData.append('middle_name', document.getElementById('id_middle_name').value);
                formData.append('last_name', document.getElementById('id_last_name').value);
                formData.append('suffix', document.getElementById('id_suffix').value);
                formData.append('username', document.getElementById('id_username').value);
                formData.append('phone_number', document.getElementById('id_phone_number').value);
                
                // Add otp_enabled
                if (document.getElementById('id_otp_enabled')) {
                    formData.append('otp_enabled', document.getElementById('id_otp_enabled').checked);
                }
                
                // Add file if present
                if (profilePicInput.files[0]) {
                    formData.append('profile_picture', profilePicInput.files[0]);
                }
                
                // Handle clear picture checkbox
                const clearCheck = document.getElementById('profile_picture-clear_id');
                if (clearCheck && clearCheck.checked) {
                    formData.append('profile_picture', ''); // Sending empty string or handling specific logic
                }

                // Note: OTP enabled/disabled might need a separate endpoint usually, 
                // but if the profile serializer handles it, we can send it.
                // However, the current serializer/view logic implies restricted fields.
                // OTP toggling usually requires password verification (separate flow).
                // For now, we won't send otp_enabled here to avoid 403 or errors unless logic is confirmed.
                // *Self-correction*: The view said "Allow otp_enabled...".
                // But typically sensitive changes require a separate flow. 
                // We'll skip sending it in the general profile PATCH for now to be safe, 
                // as the UI logic for OTP usually involves the modal.

                try {
                    const response = await fetch(API_URL, {
                        method: 'PATCH',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken')
                            // Content-Type not set for FormData to let browser set boundary
                        },
                        body: formData
                    });

                    if (response.ok) {
                        const updatedData = await response.json();
                        initialData = updatedData; // Update reference
                        populateForm(updatedData);
                        setEditMode(false);
                        unsaved.classList.add('hidden');
                        ToastNotification.success('Success', 'Profile updated successfully.');
                    } else {
                        const err = await response.json();
                        console.error('Update failed', err);
                        let msg = 'Failed to update profile.';
                        if (err.detail) msg = err.detail;
                        else if (typeof err === 'object') {
                            msg = Object.values(err).flat().join(', ');
                        }
                        ToastNotification.error('Error', msg);
                    }
                } catch (error) {
                    console.error('Network error:', error);
                    ToastNotification.error('Error', 'Network error occurred.');
                } finally {
                    showLoading(false);
                }
            });

            // --- Helpers ---
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            function showLoading(show) {
                loadingOverlay.style.display = show ? 'flex' : 'none';
            }

            // --- Profile Image Preview ---
            profilePicInput.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        preview.src = e.target.result;
                        unsaved.classList.remove('hidden');
                    };
                    reader.readAsDataURL(this.files[0]);
                }
            });

            // Initialize
            setEditMode(false);
            fetchProfileData();
        });
    </script>

    <!-- Include Modals -->
    {% include "components/disable_otp_modal.html" %}
    {% include "components/image_cropper_modal.html" %}
</body>
</html>