{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Agent Management</title>
    <link rel="stylesheet" href="{% static 'css/profile_settings.css' %}" />
    <link rel="stylesheet" href="{% static 'css/agent_management.css' %}" />
  </head>
  <body>
    <main class="agentManagementPage">
      <div class="agentManagementContainer">
        <div class="header">
          <h1>Agent Management</h1>
          <div class="headerActions">
            <a href="{% url 'profile-settings' %}" class="btn btnSecondary"
              >My Profile</a
            >
            <a href="/logout/" class="btn btnDanger">Logout</a>
          </div>
        </div>

        <!-- Toast Messages -->
        <div id="toast-container" class="toastContainer hidden"></div>

        <!-- Loading Spinner -->
        <div id="loading" class="loading hidden">
          <div class="spinner"></div>
          <p>Loading agents...</p>
        </div>

        <!-- Error Display -->
        <div id="error-container" class="errorContainer hidden">
          <p id="error-message"></p>
          <button onclick="loadAgents()" class="btn btnPrimary">Retry</button>
        </div>

        <!-- Agents List -->
        <div id="agents-container" class="agentsContainer">
          <div class="agentsHeader">
            <h2 id="agents-title">System Agents</h2>

            <div class="agentsSearch">
              <input
                type="search"
                id="search-input"
                placeholder="Search agents by username, email, name, company, or phone..."
              />
              <button id="clear-search" class="btn btnSecondary">Clear</button>
              <button id="add-agent-btn" class="btn btnPrimary" onclick="openAddAgentModal()">+ Add Agent</button>
            </div>

            <!--<div class="agentsStats">
              <span id="agents-count">Loading...</span>
            </div>-->
          </div>

          <div class="ticketTableWrapper">
            <table id="agents-table" class="agentsTable">
              <thead>
                <tr>
                  <th>Avatar</th>
                  <th>Name</th>
                  <th>Role</th>
                  <th>Email</th>
                  <th>Company</th>
                  <th>Phone</th>
                  <th>Status</th>
                  <th>Last Login</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="agents-body">
                <!-- Agents will be loaded here dynamically -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Edit Agent Modal -->
      <div id="edit-modal" class="modal hidden">
        <div class="modalContent">
          <div class="modalContentWrapper">
            <div class="modalHeader">
              <h3>Edit Agent</h3>
              <button onclick="closeEditModal()" class="modalClose">
                &times;
              </button>
            </div>
            <form id="edit-form">
              <div class="formGroup">
                <label for="edit-first-name">First Name</label>
                <input type="text" id="edit-first-name" name="first_name" />
              </div>
              <div class="formGroup">
                <label for="edit-middle-name">Middle Name</label>
                <input type="text" id="edit-middle-name" name="middle_name" />
              </div>
              <div class="formGroup">
                <label for="edit-last-name">Last Name</label>
                <input type="text" id="edit-last-name" name="last_name" />
              </div>
              <div class="formGroup">
                <label for="edit-suffix">Suffix</label>
                <select id="edit-suffix" name="suffix">
                  <option value="">---------</option>
                  <option value="Jr.">Jr.</option>
                  <option value="Sr.">Sr.</option>
                  <option value="II">II</option>
                  <option value="III">III</option>
                  <option value="IV">IV</option>
                  <option value="V">V</option>
                </select>
              </div>
              <div class="formGroup">
                <label for="edit-username">Username</label>
                <input
                  type="text"
                  id="edit-username"
                  name="username"
                  required
                />
              </div>
              <div class="formGroup">
                <label for="edit-phone">Phone Number</label>
                <input type="tel" id="edit-phone" name="phone_number" />
              </div>
              <div class="formGroup">
                <label for="edit-email">Email</label>
                <input type="email" id="edit-email" name="email" required />
              </div>
              <div class="formGroup">
                <label for="edit-company-id">Company ID</label>
                <input
                  type="text"
                  id="edit-company-id"
                  name="company_id"
                  readonly
                />
                <small>Company ID cannot be changed</small>
              </div>
              <div class="formGroup">
                <label for="edit-department">Department</label>
                <select id="edit-department" name="department">
                  <option value="">---------</option>
                  <option value="IT Department">IT Department</option>
                  <option value="Asset Department">Asset Department</option>
                  <option value="Budget Department">Budget Department</option>
                </select>
              </div>
              <div class="formGroup">
                <label for="edit-asset-department">Asset Department</label>
                <input type="text" id="edit-asset-department" name="asset_department" />
              </div>
              <div class="formGroup">
                <label for="edit-active">Status</label>
                <select id="edit-active" name="is_active">
                  <option value="true">Active</option>
                  <option value="false">Inactive</option>
                </select>
              </div>
              <div class="modalActions">
                <button
                  type="button"
                  onclick="closeEditModal()"
                  class="btn btnSecondary"
                >
                  Cancel
                </button>
                <button type="submit" class="btn btnPrimary">
                  Save Changes
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Add Agent Modal -->
      <div id="add-modal" class="modal hidden">
        <div class="modalContent">
          <div class="modalContentWrapper">
            <div class="modalHeader">
              <h3>Invite New Agent</h3>
              <button onclick="closeAddModal()" class="modalClose">
                &times;
              </button>
            </div>
            <form id="add-form">
              <div class="formGroup">
                <label for="add-first-name">First Name</label>
                <input type="text" id="add-first-name" name="first_name" />
              </div>
              <div class="formGroup">
                <label for="add-middle-name">Middle Name</label>
                <input type="text" id="add-middle-name" name="middle_name" />
              </div>
              <div class="formGroup">
                <label for="add-last-name">Last Name</label>
                <input type="text" id="add-last-name" name="last_name" />
              </div>
              <div class="formGroup">
                <label for="add-suffix">Suffix</label>
                <select id="add-suffix" name="suffix">
                  <option value="">---------</option>
                  <option value="Jr.">Jr.</option>
                  <option value="Sr.">Sr.</option>
                  <option value="II">II</option>
                  <option value="III">III</option>
                  <option value="IV">IV</option>
                  <option value="V">V</option>
                </select>
              </div>
              <div class="formGroup">
                <label for="add-email">Email</label>
                <input type="email" id="add-email" name="email" required />
                <small>User will receive login credentials via email</small>
              </div>
              <div class="formGroup">
                <label for="add-phone">Phone Number</label>
                <input type="tel" id="add-phone" name="phone_number" />
              </div>
              <div class="formGroup">
                <label for="add-department">Department</label>
                <select id="add-department" name="department">
                  <option value="">---------</option>
                  <option value="IT Department">IT Department</option>
                  <option value="Asset Department">Asset Department</option>
                  <option value="Budget Department">Budget Department</option>
                </select>
              </div>
              <div class="formGroup">
                <label for="add-role">Role & System</label>
                <select id="add-role" name="role_id" required>
                  <option value="">Select a role...</option>
                  <!-- Roles will be loaded dynamically -->
                </select>
              </div>
              <div class="modalActions">
                <button
                  type="button"
                  onclick="closeAddModal()"
                  class="btn btnSecondary"
                >
                  Cancel
                </button>
                <button type="submit" class="btn btnPrimary">
                  Invite Agent
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- View Agent Modal -->
      <div id="view-modal" class="modal hidden">
        <div class="modalContentWrapper">
          <div class="modalContent">
            <div class="modalHeader">
              <h3>Agent Details</h3>
              <button onclick="closeViewModal()" class="modalClose">
                &times;
              </button>
            </div>
            <div class="agentDetails" id="agent-details">
              <!-- Agent details will be loaded here -->
            </div>
            <div class="modalActions">
              <button onclick="closeViewModal()" class="btn btnSecondary">
                Close
              </button>
              <button onclick="editFromView()" class="btn btnPrimary">
                Edit Agent
              </button>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script>
      // Get CSRF token from cookies
      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
          const cookies = document.cookie.split(";");
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === name + "=") {
              cookieValue = decodeURIComponent(
                cookie.substring(name.length + 1)
              );
              break;
            }
          }
        }
        return cookieValue;
      }

      const csrfToken = getCookie("csrftoken");
      let currentAgentId = null;
      let agents = [];

      // Toast notification system
      function showToast(message, type = "info") {
        const container = document.getElementById("toast-container");
        const toast = document.createElement("div");
        toast.className = `toast ${type}`;
        toast.textContent = message;

        container.appendChild(toast);
        container.classList.remove("hidden");

        setTimeout(() => {
          toast.remove();
          if (container.children.length === 0) {
            container.classList.add("hidden");
          }
        }, 5000);
      }

      // Show/hide loading
      function showLoading() {
        document.getElementById("loading").classList.remove("hidden");
        document.getElementById("agents-container").classList.add("hidden");
        document.getElementById("error-container").classList.add("hidden");
      }

      function hideLoading() {
        document.getElementById("loading").classList.add("hidden");
      }

      // Show error
      function showError(message) {
        document.getElementById("error-message").textContent = message;
        document.getElementById("error-container").classList.remove("hidden");
        document.getElementById("agents-container").classList.add("hidden");
        hideLoading();
      }

      // Load agents from API
      async function loadAgents() {
        showLoading();

        try {
          const response = await fetch("/api/v1/users/list/", {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": csrfToken,
            },
            credentials: "include",
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          agents = data.users || [];

          // Log the data to console for debugging
          console.log("Loaded agents:", agents);

          displayAgents(agents);
          const totalCount = agents.length;
          // Update both the H2 title and the small stats span
          const titleEl = document.getElementById("agents-title");
          const countEl = document.getElementById("agents-count");
          if (titleEl) titleEl.textContent = `System Agents (${totalCount})`;
          if (countEl) countEl.textContent = `${totalCount} agents found`;

          document
            .getElementById("agents-container")
            .classList.remove("hidden");
          hideLoading();
        } catch (error) {
          console.error("Error loading agents:", error);
          showError(
            "Failed to load agents. Please check your connection and try again."
          );
        }
      }

      // Display agents in table
      function displayAgents(agentsData) {
        const tableBody = document.getElementById("agents-body");
        tableBody.innerHTML = "";

        if (agentsData.length === 0) {
          tableBody.innerHTML = `
            <tr>
                <td colspan="9" class="noAgents">No agents found.</td>
            </tr>`;
          return;
        }

        agentsData.forEach((agent) => {
          const row = createAgentRow(agent);
          tableBody.appendChild(row);
        });
      }

      // Debounce helper (prevents filtering on every keystroke)
      function debounce(fn, delay) {
        let timeout;
        return function (...args) {
          clearTimeout(timeout);
          timeout = setTimeout(() => fn.apply(this, args), delay);
        };
      }

      // Search/filter logic
      function applySearchFilter() {
        const query = document
          .getElementById("search-input")
          .value.trim()
          .toLowerCase();

        if (!query) {
          displayAgents(agents);
          const totalCount = agents.length;
          const titleEl = document.getElementById("agents-title");
          const countEl = document.getElementById("agents-count");
          if (titleEl) titleEl.textContent = `System Agents (${totalCount})`;
          if (countEl) countEl.textContent = `${totalCount} agents found`;
          return;
        }

        const filtered = agents.filter((a) => {
          const username = (a.username || "").toLowerCase();
          const email = (a.email || "").toLowerCase();
          const company = (a.company_name || "").toLowerCase();
          const phone = (a.phone_number || "").toLowerCase();
          const fullName = `${a.first_name || ""} ${
            a.last_name || ""
          }`.toLowerCase();

          return (
            username.includes(query) ||
            email.includes(query) ||
            company.includes(query) ||
            phone.includes(query) ||
            fullName.includes(query)
          );
        });

        displayAgents(filtered);
        const filteredCount = filtered.length;
        const titleEl = document.getElementById("agents-title");
        const countEl = document.getElementById("agents-count");
        if (titleEl) titleEl.textContent = `System Agents (${filteredCount})`;
        if (countEl) countEl.textContent = `${filteredCount} agents found`;
      }

      const debouncedApplySearch = debounce(applySearchFilter, 250);

      // Attach listeners for search input and clear button
      const searchInput = document.getElementById("search-input");
      const clearButton = document.getElementById("clear-search");
      if (searchInput) {
        searchInput.addEventListener("input", debouncedApplySearch);
      }
      if (clearButton) {
        clearButton.addEventListener("click", function () {
          if (searchInput) searchInput.value = "";
          applySearchFilter();
        });
      }

      // Create table row for an agent
      function createAgentRow(agent) {
        const roleName =
          agent.system_roles && agent.system_roles.length > 0
            ? agent.system_roles[0].role_name
            : "N/A"; // fallback if no role

        const row = document.createElement("tr");
        row.innerHTML = `
        <td>
            <img src="${
              agent.profile_picture ||
              "https://i.pinimg.com/1200x/a9/a8/c8/a9a8c8258957c8c7d6fcd320e9973203.jpg"
            }" 
                 alt="${agent.username}" 
                 class="agentAvatarSmall">
        </td>
        <td>${agent.first_name || ""} ${agent.last_name || ""}</td>
        <td>${roleName}</td>
        <td>${agent.email}</td>
        <td>${agent.company_name || "N/A"}</td>
        <td>${agent.phone_number || "N/A"}</td>
        <td>
            <span class="agentStatus ${
              agent.is_active ? "active" : "inactive"
            }">
                ${agent.is_active ? "Active" : "Inactive"}
            </span>
        </td>
        <td>${
          agent.last_login
            ? new Date(agent.last_login).toLocaleDateString()
            : "Never"
        }</td>
        <td>
            <button onclick="viewAgent(${
              agent.id
            })" class="btn btnSecondary btnSmall">View</button>
            <button onclick="editAgent(${
              agent.id
            })" class="btn btnPrimary btnSmall">Edit</button>
        </td>
    `;
        return row;
      }

      // View agent details
      async function viewAgent(agentId) {
        try {
          const response = await fetch(`/api/v1/users/${agentId}/`, {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": csrfToken,
            },
            credentials: "include",
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const agent = await response.json();
          currentAgentId = agentId;

          const detailsHtml = `
            <div class="agentProfileContainer">
              <div class="agentProfileImage">
                <img src="${
                  agent.profile_picture ||
                  "https://i.pinimg.com/1200x/a9/a8/c8/a9a8c8258957c8c7d6fcd320e9973203.jpg"
                }" alt="${agent.username}">
              </div>
              <div class="agentProfileInfo">
                <h3>${agent.first_name || ""} ${agent.middle_name || ""} ${agent.last_name || ""} ${agent.suffix || ""}</h3>
                <p class="agentUsername">@${agent.username}</p>
                <div class="agentInfoGrid">
                  <div><strong>Email:</strong> ${agent.email}</div>
                  <div><strong>Phone:</strong> ${
                    agent.phone_number || "N/A"
                  }</div>
                  <div><strong>Company:</strong> ${
                    agent.company_name || "N/A"
                  }</div>
                  <div><strong>Status:</strong> 
                    <span class="agentStatus ${
                      agent.is_active ? "active" : "inactive"
                    }">
                      ${agent.is_active ? "Active" : "Inactive"}
                    </span>
                  </div>
                  <div><strong>Date Joined:</strong> ${new Date(
                    agent.date_joined
                  ).toLocaleDateString()}</div>
                  <div><strong>Last Login:</strong> ${
                    agent.last_login
                      ? new Date(agent.last_login).toLocaleDateString()
                      : "Never"
                  }</div>
                </div>
              </div>
            </div>
          `;

          document.getElementById("agent-details").innerHTML = detailsHtml;
          document.getElementById("view-modal").classList.remove("hidden");
        } catch (error) {
          console.error("Error loading agent details:", error);
          showToast("Failed to load agent details", "error");
        }
      }

      // Edit agent
      async function editAgent(agentId) {
        // check
        if (!agentId) {
          console.error("❌ editAgent called with null/undefined ID");
          showToast(
            "Invalid agent ID — please refresh and try again.",
            "error"
          );
          return;
        }

        try {
          const response = await fetch(`/api/v1/users/${agentId}/`, {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": csrfToken,
            },
            credentials: "include",
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const agent = await response.json();
          currentAgentId = agentId;

          // Populate form
          document.getElementById("edit-first-name").value =
            agent.first_name || "";
          document.getElementById("edit-middle-name").value =
            agent.middle_name || "";
          document.getElementById("edit-last-name").value =
            agent.last_name || "";
          document.getElementById("edit-suffix").value =
            agent.suffix || "";
          document.getElementById("edit-username").value = agent.username || "";
          document.getElementById("edit-phone").value =
            agent.phone_number || "";
          document.getElementById("edit-email").value = agent.email || "";
          document.getElementById("edit-company-id").value =
            agent.company_id || agent.company_name || "";
          document.getElementById("edit-department").value =
            agent.department || "";

          document.getElementById("edit-active").value = agent.is_active
            ? "true"
            : "false";

          document.getElementById("edit-modal").classList.remove("hidden");
        } catch (error) {
          console.error("Error loading agent for edit:", error);
          showToast("Failed to load agent data for editing", "error");
        }
      }

      // Edit from view modal
      function editFromView() {
        const agentId = currentAgentId; // Save the ID before closing modal
        closeViewModal();
        editAgent(agentId);
      }

      // Close modals
      function closeEditModal() {
        document.getElementById("edit-modal").classList.add("hidden");
        currentAgentId = null;
      }

      function closeViewModal() {
        document.getElementById("view-modal").classList.add("hidden");
        currentAgentId = null;
      }

      // Handle edit form submission
      document
        .getElementById("edit-form")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          if (!currentAgentId) return;

          const formData = new FormData(this);
          const data = {
            first_name: formData.get("first_name"),
            middle_name: formData.get("middle_name"),
            last_name: formData.get("last_name"),
            suffix: formData.get("suffix"),
            username: formData.get("username"),
            phone_number: formData.get("phone_number"),
            email: formData.get("email"),
            department: formData.get("department"),
            asset_department: formData.get("asset_department"),
            is_active: formData.get("is_active") === "true",
          };

          try {
            const response = await fetch(`/api/v1/users/${currentAgentId}/`, {
              method: "PATCH",
              headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrfToken,
              },
              credentials: "include",
              body: JSON.stringify(data),
            });

            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.error || "Failed to update agent");
            }

            const updatedAgent = await response.json();
            showToast("Agent updated successfully", "success");
            closeEditModal();
            loadAgents(); // Refresh the list
          } catch (error) {
            console.error("Error updating agent:", error);
            showToast(error.message || "Failed to update agent", "error");
          }
        });

      // Close modals when clicking outside
      window.addEventListener("click", function (e) {
        const editModal = document.getElementById("edit-modal");
        const viewModal = document.getElementById("view-modal");
        const addModal = document.getElementById("add-modal");

        if (e.target === editModal) {
          closeEditModal();
        }
        if (e.target === viewModal) {
          closeViewModal();
        }
        if (e.target === addModal) {
          closeAddModal();
        }
      });

      // Open Add Agent Modal
      async function openAddAgentModal() {
        document.getElementById("add-form").reset();
        
        // Load available roles
        try {
          const response = await fetch("/api/v1/system-roles/invite/", {
            method: "OPTIONS",
            headers: {
              "X-CSRFToken": csrfToken,
            },
            credentials: "include",
          });
          
          // Alternative: fetch roles from a dedicated endpoint if available
          // For now, we'll fetch roles manually
          await loadRoles();
          
          document.getElementById("add-modal").classList.remove("hidden");
        } catch (error) {
          console.error("Error loading roles:", error);
          showToast("Failed to load roles. Please try again.", "error");
        }
      }

      // Load available roles for the role dropdown
      async function loadRoles() {
        try {
          // This may need adjustment based on your actual roles endpoint
          const response = await fetch("/api/v1/roles/", {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": csrfToken,
            },
            credentials: "include",
          });

          if (response.ok) {
            const roles = await response.json();
            const roleSelect = document.getElementById("add-role");
            roleSelect.innerHTML = '<option value="">Select a role...</option>';
            
            // Assuming roles is an array of {id, name, system_name} objects
            roles.forEach(role => {
              const option = document.createElement("option");
              option.value = role.id;
              option.textContent = `${role.name} (${role.system_name || role.system})`;
              roleSelect.appendChild(option);
            });
          }
        } catch (error) {
          console.error("Error loading roles:", error);
          // If roles endpoint doesn't exist, we'll just show the empty dropdown
          // and let the backend validation handle it
        }
      }

      // Close Add Agent Modal
      function closeAddModal() {
        document.getElementById("add-modal").classList.add("hidden");
        document.getElementById("add-form").reset();
      }

      // Handle add agent form submission
      document
        .getElementById("add-form")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const formData = new FormData(this);
          
          // Create form data in the format expected by the invite endpoint
          const inviteData = new FormData();
          inviteData.append('email', formData.get('email'));
          inviteData.append('first_name', formData.get('first_name') || '');
          inviteData.append('middle_name', formData.get('middle_name') || '');
          inviteData.append('last_name', formData.get('last_name') || '');
          inviteData.append('suffix', formData.get('suffix') || '');
          inviteData.append('phone_number', formData.get('phone_number') || '');
          inviteData.append('department', formData.get('department') || '');
          inviteData.append('role_id', formData.get('role_id'));

          try {
            const response = await fetch("/api/v1/system-roles/invite/", {
              method: "POST",
              headers: {
                "X-CSRFToken": csrfToken,
              },
              credentials: "include",
              body: inviteData,
            });

            if (!response.ok) {
              const errorData = await response.json();
              const errorMsg = errorData.error || errorData.detail || "Failed to invite agent";
              throw new Error(errorMsg);
            }

            const result = await response.json();
            
            // Show success message with temporary password if user was newly created
            if (result.temporary_password) {
              showToast(
                `Agent invited successfully! Temporary password: ${result.temporary_password}`, 
                "success"
              );
              // You might want to show this in a more prominent way
              alert(`Agent invited successfully!\n\nEmail: ${result.user}\nTemporary Password: ${result.temporary_password}\nRole: ${result.role}\nSystem: ${result.system}\n\nPlease save this password securely.`);
            } else {
              showToast(`Agent ${result.user} has been assigned to ${result.role} role`, "success");
            }
            
            closeAddModal();
            loadAgents(); // Refresh the list
          } catch (error) {
            console.error("Error inviting agent:", error);
            showToast(error.message || "Failed to invite agent", "error");
          }
        });

      // Initialize page
      document.addEventListener("DOMContentLoaded", function () {
        loadAgents();
      });
    </script>
  </body>
</html>
