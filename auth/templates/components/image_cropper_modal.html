<!-- Image Cropper Modal -->
<div id="image-cropper-modal" class="image-cropper-overlay">
    <div class="image-cropper-modal">
        <div class="image-cropper-header">
            <h3>Edit Profile Picture</h3>
            <button type="button" class="modal-close-btn" id="cropper-close-btn">&times;</button>
        </div>
        <div class="image-cropper-body">
            <div class="cropper-container">
                <div class="canvas-wrapper">
                    <canvas id="cropper-canvas"></canvas>
                    <div class="crop-circle-overlay"></div>
                </div>
            </div>
            <div class="cropper-controls">
                <div class="control-group">
                    <label for="zoom-slider">Zoom</label>
                    <div class="slider-container">
                        <input type="range" id="zoom-slider" class="zoom-slider" 
                               min="0.5" max="3" step="0.01" value="1">
                        <span id="zoom-value" class="zoom-value">100%</span>
                    </div>
                </div>
                <div class="control-group">
                    <label for="rotate-slider">Rotate</label>
                    <div class="slider-container">
                        <input type="range" id="rotate-slider" class="rotate-slider" 
                               min="0" max="360" step="1" value="0">
                        <span id="rotate-value" class="rotate-value">0°</span>
                    </div>
                </div>
                <div class="control-group button-group">
                    <button type="button" id="rotate-left-btn" class="control-btn">
                        ↺ Rotate Left
                    </button>
                    <button type="button" id="rotate-right-btn" class="control-btn">
                        ↻ Rotate Right
                    </button>
                    <button type="button" id="reset-btn" class="control-btn">
                        ⟲ Reset
                    </button>
                </div>
            </div>
        </div>
        <div class="image-cropper-footer">
            <button type="button" class="cancelBtn" id="cropper-cancel-btn">Cancel</button>
            <button type="button" class="applyBtn" id="cropper-apply-btn">Apply</button>
        </div>
    </div>
</div>

<style>
    /* Image Cropper Modal */
    .image-cropper-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s, visibility 0.3s;
    }

    .image-cropper-overlay.active {
        opacity: 1;
        visibility: visible;
    }

    .image-cropper-modal {
        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        max-width: 550px;
        width: 95%;
        max-height: 95vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        transform: scale(0.9);
        transition: transform 0.3s;
    }

    .image-cropper-overlay.active .image-cropper-modal {
        transform: scale(1);
    }

    .image-cropper-header {
        padding: 20px;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
    }

    .image-cropper-header h3 {
        margin: 0;
        font-size: 20px;
        color: #333;
    }

    .modal-close-btn {
        background: none;
        border: none;
        font-size: 28px;
        color: #999;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        line-height: 1;
        transition: color 0.2s;
    }

    .modal-close-btn:hover {
        color: #333;
    }

    .image-cropper-body {
        padding: 20px;
        overflow-y: auto;
        flex: 1;
    }

    .cropper-container {
        margin-bottom: 20px;
        position: relative;
    }

    .canvas-wrapper {
        position: relative;
        width: 400px;
        height: 400px;
        margin: 0 auto;
        background: #f9f9f9;
        border-radius: 8px;
        overflow: hidden;
        touch-action: none;
    }

    #cropper-canvas {
        display: block;
        cursor: grab;
        user-select: none;
        -webkit-user-select: none;
        width: 100%;
        height: 100%;
    }

    #cropper-canvas:active {
        cursor: grabbing;
    }

    .crop-circle-overlay {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 300px;
        height: 300px;
        margin-left: -150px;
        margin-top: -150px;
        border: 2px solid rgba(255, 255, 255, 0.8);
        border-radius: 50%;
        box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
        pointer-events: none;
        z-index: 1;
    }

    .cropper-controls {
        margin-bottom: 20px;
    }

    .control-group {
        margin-bottom: 15px;
    }

    .control-group label {
        display: block;
        margin-bottom: 8px;
        font-size: 14px;
        color: #333;
        font-weight: 500;
    }

    .slider-container {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .zoom-slider,
    .rotate-slider {
        flex: 1;
        height: 6px;
        border-radius: 3px;
        background: #ddd;
        outline: none;
        -webkit-appearance: none;
        appearance: none;
        cursor: pointer;
    }

    .zoom-slider::-webkit-slider-thumb,
    .rotate-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: #007bff;
        cursor: pointer;
        transition: background 0.2s;
    }

    .zoom-slider::-webkit-slider-thumb:hover,
    .rotate-slider::-webkit-slider-thumb:hover {
        background: #0056b3;
    }

    .zoom-slider::-moz-range-thumb,
    .rotate-slider::-moz-range-thumb {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: #007bff;
        cursor: pointer;
        border: none;
        transition: background 0.2s;
    }

    .zoom-value,
    .rotate-value {
        font-size: 14px;
        color: #666;
        min-width: 50px;
        text-align: right;
    }

    .button-group {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
    }

    .control-btn {
        padding: 10px 12px;
        border: 1px solid #ddd;
        background: #f5f5f5;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        color: #333;
    }

    .control-btn:hover {
        background: #e0e0e0;
        border-color: #999;
    }

    .image-cropper-footer {
        padding: 20px;
        border-top: 1px solid #e0e0e0;
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        flex-shrink: 0;
    }

    .image-cropper-footer button {
        padding: 10px 20px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s;
    }

    .cancelBtn {
        background: #f0f0f0;
        color: #333;
    }

    .cancelBtn:hover {
        background: #e0e0e0;
    }

    .applyBtn {
        background: #007bff;
        color: white;
    }

    .applyBtn:hover {
        background: #0056b3;
    }

    @media (max-width: 600px) {
        .canvas-wrapper {
            width: 100%;
            height: auto;
            aspect-ratio: 1;
        }

        .crop-circle-overlay {
            width: 70%;
            height: 70%;
            margin-left: -35%;
            margin-top: -35%;
        }

        .button-group {
            grid-template-columns: 1fr;
        }
    }
</style>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        class ImageCropper {
            constructor() {
                this.canvas = document.getElementById('cropper-canvas');
                if (!this.canvas) return;
                
                this.ctx = this.canvas.getContext('2d');
                this.modal = document.getElementById('image-cropper-modal');
                this.canvasWrapper = document.querySelector('.canvas-wrapper');
                
                // State
                this.image = null;
                this.scale = 1;
                this.rotation = 0;
                this.offsetX = 0;
                this.offsetY = 0;
                this.isDragging = false;
                this.lastX = 0;
                this.lastY = 0;
                
                // UI Elements
                this.zoomSlider = document.getElementById('zoom-slider');
                this.zoomValue = document.getElementById('zoom-value');
                this.rotateSlider = document.getElementById('rotate-slider');
                this.rotateValue = document.getElementById('rotate-value');
                
                this.initCanvas();
                this.bindEvents();
            }
            
            initCanvas() {
                const size = Math.min(this.canvasWrapper.offsetWidth, 400);
                this.canvas.width = size;
                this.canvas.height = size;
                this.centerX = size / 2;
                this.centerY = size / 2;
            }
            
            bindEvents() {
                // File input
                const fileInput = document.getElementById('id_profile_picture');
                if (fileInput) {
                    console.log('ImageCropper: Found file input, binding change event');
                    fileInput.addEventListener('change', (e) => {
                        console.log('ImageCropper: File selected');
                        this.loadImage(e.target.files[0]);
                    });
                } else {
                    console.error('ImageCropper: File input #id_profile_picture not found');
                }
                
                // Zoom
                this.zoomSlider.addEventListener('input', (e) => {
                    this.scale = parseFloat(e.target.value);
                    this.zoomValue.textContent = Math.round(this.scale * 100) + '%';
                    this.render();
                });
                
                // Rotation
                this.rotateSlider.addEventListener('input', (e) => {
                    this.rotation = parseInt(e.target.value);
                    this.rotateValue.textContent = this.rotation + '°';
                    this.render();
                });
                
                // Rotate buttons
                document.getElementById('rotate-left-btn').addEventListener('click', () => {
                    this.rotation = (this.rotation - 90 + 360) % 360;
                    this.rotateSlider.value = this.rotation;
                    this.rotateValue.textContent = this.rotation + '°';
                    this.render();
                });
                
                document.getElementById('rotate-right-btn').addEventListener('click', () => {
                    this.rotation = (this.rotation + 90) % 360;
                    this.rotateSlider.value = this.rotation;
                    this.rotateValue.textContent = this.rotation + '°';
                    this.render();
                });
                
                // Reset
                document.getElementById('reset-btn').addEventListener('click', () => {
                    this.reset();
                });
                
                // Mouse drag
                this.canvas.addEventListener('mousedown', (e) => this.startDrag(e));
                document.addEventListener('mousemove', (e) => this.drag(e));
                document.addEventListener('mouseup', () => this.endDrag());
                
                // Touch drag
                this.canvas.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.startDrag(e.touches[0]);
                });
                document.addEventListener('touchmove', (e) => {
                    if (this.isDragging) {
                        e.preventDefault();
                        this.drag(e.touches[0]);
                    }
                });
                document.addEventListener('touchend', () => this.endDrag());
                
                // Mouse wheel zoom
                this.canvas.addEventListener('wheel', (e) => {
                    e.preventDefault();
                    const delta = e.deltaY > 0 ? -0.1 : 0.1;
                    this.scale = Math.max(0.5, Math.min(3, this.scale + delta));
                    this.zoomSlider.value = this.scale;
                    this.zoomValue.textContent = Math.round(this.scale * 100) + '%';
                    this.render();
                });
                
                // Modal controls
                document.getElementById('cropper-close-btn').addEventListener('click', () => {
                    this.closeModal();
                });
                document.getElementById('cropper-cancel-btn').addEventListener('click', () => {
                    this.closeModal();
                });
                document.getElementById('cropper-apply-btn').addEventListener('click', () => {
                    this.applyCrop();
                });
                
                // Close on overlay click
                this.modal.addEventListener('click', (e) => {
                    if (e.target === this.modal) {
                        this.closeModal();
                    }
                });
            }
            
            loadImage(file) {
                if (!file || !file.type.match('image.*')) {
                    console.error('ImageCropper: Invalid file or no file selected');
                    return;
                }
                console.log('ImageCropper: Loading image');
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        this.image = img;
                        this.reset();
                        this.openModal();
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
            
            reset() {
                if (!this.image) return;
                
                // Calculate initial scale to fit image
                const canvasSize = this.canvas.width;
                const imgRatio = this.image.width / this.image.height;
                const cropSize = canvasSize * 0.75; // 75% of canvas
                
                if (imgRatio > 1) {
                    // Landscape
                    this.scale = cropSize / this.image.height;
                } else {
                    // Portrait or square
                    this.scale = cropSize / this.image.width;
                }
                
                this.rotation = 0;
                this.offsetX = 0;
                this.offsetY = 0;
                
                this.zoomSlider.value = this.scale;
                this.zoomValue.textContent = Math.round(this.scale * 100) + '%';
                this.rotateSlider.value = 0;
                this.rotateValue.textContent = '0°';
                
                this.render();
            }
            
            startDrag(e) {
                this.isDragging = true;
                this.lastX = e.clientX;
                this.lastY = e.clientY;
            }
            
            drag(e) {
                if (!this.isDragging) return;
                
                const deltaX = e.clientX - this.lastX;
                const deltaY = e.clientY - this.lastY;
                
                this.offsetX += deltaX;
                this.offsetY += deltaY;
                
                // Apply boundary constraints
                this.constrainOffset();
                
                this.lastX = e.clientX;
                this.lastY = e.clientY;
                
                this.render();
            }
            
            constrainOffset() {
                if (!this.image) return;
                
                // Calculate the scaled image dimensions
                const scaledWidth = this.image.width * this.scale;
                const scaledHeight = this.image.height * this.scale;
                
                // Get the crop circle radius (150px since it's 300px diameter, centered)
                const cropRadius = 150;
                
                // Maximum allowed offset in each direction
                // The image should not move more than: (scaled dimension - crop radius)
                const maxOffsetX = (scaledWidth - cropRadius) / 2;
                const maxOffsetY = (scaledHeight - cropRadius) / 2;
                
                // Constrain offsets to keep image within bounds
                this.offsetX = Math.max(-maxOffsetX, Math.min(maxOffsetX, this.offsetX));
                this.offsetY = Math.max(-maxOffsetY, Math.min(maxOffsetY, this.offsetY));
            }
            
            endDrag() {
                this.isDragging = false;
            }
            
            render() {
                if (!this.image) return;
                
                const ctx = this.ctx;
                const canvas = this.canvas;
                
                // Clear canvas
                ctx.fillStyle = '#f0f0f0';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Save context
                ctx.save();
                
                // Move to center
                ctx.translate(this.centerX, this.centerY);
                
                // Apply user transformations
                ctx.translate(this.offsetX, this.offsetY);
                ctx.rotate((this.rotation * Math.PI) / 180);
                ctx.scale(this.scale, this.scale);
                
                // Draw image centered
                ctx.drawImage(
                    this.image,
                    -this.image.width / 2,
                    -this.image.height / 2,
                    this.image.width,
                    this.image.height
                );
                
                // Restore context
                ctx.restore();
            }
            
            applyCrop() {
                if (!this.image) return;
                
                // Create output canvas at high resolution
                const outputSize = 600; // High-res output
                const outputCanvas = document.createElement('canvas');
                const outputCtx = outputCanvas.getContext('2d');
                
                outputCanvas.width = outputSize;
                outputCanvas.height = outputSize;
                
                // Calculate crop circle dimensions
                const cropRadius = outputSize / 2;
                const scaleFactor = outputSize / this.canvas.width;
                
                // Fill with white background
                outputCtx.fillStyle = '#ffffff';
                outputCtx.fillRect(0, 0, outputSize, outputSize);
                
                // Create circular clipping path
                outputCtx.beginPath();
                outputCtx.arc(cropRadius, cropRadius, cropRadius, 0, Math.PI * 2);
                outputCtx.clip();
                
                // Apply transformations scaled up
                outputCtx.save();
                outputCtx.translate(cropRadius, cropRadius);
                outputCtx.translate(this.offsetX * scaleFactor, this.offsetY * scaleFactor);
                outputCtx.rotate((this.rotation * Math.PI) / 180);
                outputCtx.scale(this.scale * scaleFactor, this.scale * scaleFactor);
                
                // Draw image
                outputCtx.drawImage(
                    this.image,
                    -this.image.width / 2,
                    -this.image.height / 2,
                    this.image.width,
                    this.image.height
                );
                
                outputCtx.restore();
                
                // Convert to blob and update preview
                outputCanvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const preview = document.getElementById('profile-preview');
                    if (preview) {
                        preview.src = url;
                    }
                    
                    // Update file input
                    const file = new File([blob], 'profile-picture.png', { type: 'image/png' });
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    const fileInput = document.getElementById('id_profile_picture');
                    if (fileInput) {
                        fileInput.files = dataTransfer.files;
                    }
                    
                    // Show unsaved warning
                    const unsaved = document.getElementById('unsaved-warning');
                    if (unsaved) {
                        unsaved.classList.remove('hidden');
                    }
                    
                    this.closeModal();
                }, 'image/png', 0.95);
            }
            
            openModal() {
                console.log('ImageCropper: Opening modal');
                this.modal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
            
            closeModal() {
                this.modal.classList.remove('active');
                document.body.style.overflow = '';
            }
        }
        
        // Initialize cropper when DOM is ready
        window.imageCropperInstance = null;
        
        function initCropper() {
            if (window.imageCropperInstance) return;
            console.log('ImageCropper: Initializing...');
            window.imageCropperInstance = new ImageCropper();
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initCropper);
        } else {
            initCropper();
        }
    });
</script>
