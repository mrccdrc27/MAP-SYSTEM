{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Assign Agent to Role</title>
  <link rel="stylesheet" href="{% static 'css/profile_settings.css' %}" />
  <link rel="stylesheet" href="{% static 'css/agent_management.css' %}" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    .assignAgentPage {
      min-height: 100vh;
      background-color: #f1f3f5;
      padding: 20px 0;
      margin-left: 250px;
    }

    .assignAgentContainer {
      width: 100%;
      margin: 0 2.5vw;
    }

    .assignAgentContent {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      max-width: 600px;
      margin: 30px auto;
    }

    .assignAgentHeader {
      padding: 30px;
      border-bottom: 1px solid #e9ecef;
      background-color: #f8f9fa;
    }

    .assignAgentHeader h2 {
      margin: 0;
      color: var(--text-color);
      font-size: 24px;
      font-weight: 600;
    }

    .assignAgentHeader p {
      margin: 10px 0 0 0;
      color: var(--secondary-text-color);
      font-size: 14px;
    }

    .assignAgentForm {
      padding: 30px;
    }

    .formGroup {
      margin-bottom: 25px;
      display: flex;
      flex-direction: column;
    }

    .formGroup label {
      font-weight: 600;
      color: var(--text-color);
      margin-bottom: 8px;
      font-size: 14px;
    }

    .formGroup select,
    .formGroup input {
      padding: 10px 12px;
      border: 1px solid #cccccc;
      border-radius: 4px;
      font-size: 14px;
      font-family: "Poppins", sans-serif;
      transition: all 0.2s ease;
    }

    .formGroup select:hover,
    .formGroup input:hover {
      border-color: var(--primary-color);
    }

    .formGroup select:focus,
    .formGroup input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }

    .formGroup select {
      background-color: #f9f9f9;
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23333' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
      padding-right: 30px;
    }

    .formActions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #e9ecef;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s ease;
      text-align: center;
    }

    .btnPrimary {
      background-color: var(--primary-color);
      color: white;
    }

    .btnPrimary:hover {
      background-color: var(--primary-color-hover);
    }

    .btnSecondary {
      background-color: #6c757d;
      color: white;
    }

    .btnSecondary:hover {
      background-color: #5a6268;
    }

    /* Toast Messages */
    .toastContainer {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .toast {
      padding: 12px 20px;
      border-radius: 6px;
      color: white;
      font-weight: 500;
      min-width: 300px;
      opacity: 0;
      transform: translateX(100%);
      animation: slideIn 0.3s ease forwards;
    }

    .toast.success {
      background-color: #28a745;
    }

    .toast.error {
      background-color: #dc3545;
    }

    .toast.info {
      background-color: var(--primary-color);
    }

    @keyframes slideIn {
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .hidden {
      display: none !important;
    }

    .errorMessage {
      color: #dc3545;
      font-size: 14px;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  {% include "components/nav.html" %}
  
  <main class="assignAgentPage">
    <div class="assignAgentContainer">
      <!-- Toast Messages -->
      <div id="toast-container" class="toastContainer hidden"></div>

      <div class="assignAgentContent">
        <div class="assignAgentHeader">
          <h2>Assign Agent to Role</h2>
          <p>Select a user and role to assign them to the TTS system</p>
        </div>

        <form id="assign-form" class="assignAgentForm">
          {% csrf_token %}

          <div class="formGroup">
            <label for="userID">Select User <span style="color: #dc3545;">*</span></label>
            <select id="userID" name="userID" required>
              <option value="">-- Choose a user --</option>
            </select>
            <div id="userID-error" class="errorMessage hidden"></div>
          </div>

          <div class="formGroup">
            <label for="role">Select Role <span style="color: #dc3545;">*</span></label>
            <select id="role" name="role" required>
              <option value="">-- Choose a role --</option>
            </select>
            <div id="role-error" class="errorMessage hidden"></div>
          </div>

          <div class="formActions">
            <button type="button" onclick="window.history.back()" class="btn btnSecondary">Cancel</button>
            <button type="submit" class="btn btnPrimary">Assign Role</button>
          </div>
        </form>
      </div>

      <!-- Assigned Users List -->
      <div class="agentsContainer" style="margin-top: 30px; max-width: 900px; margin-left: auto; margin-right: auto;">
        <div class="agentsHeader">
          <h2>Current TTS Role Assignments</h2>
        </div>

        <div id="assignments-loading" class="loading" style="display: none; text-align: center; padding: 40px;">
          <div class="spinner"></div>
          <p>Loading assignments...</p>
        </div>

        <div id="assignments-error" class="errorContainer hidden" style="text-align: center; padding: 40px;">
          <p id="assignments-error-message"></p>
          <button onclick="loadAssignments()" class="btn btnPrimary">Retry</button>
        </div>

        <div class="ticketTableWrapper" id="assignments-wrapper">
          <table class="agentsTable" id="assignments-table">
            <thead>
              <tr>
                <th>User ID</th>
                <th>First Name</th>
                <th>Last Name</th>
                <th>Email</th>
                <th>Role</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="assignments-body">
              <!-- Assignments will be loaded here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <script>
    const API_BASE = "{% url 'tts:assign_agent_to_role' %}";
    const CSRF_TOKEN = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // Toast notification system
    function showToast(message, type = 'info') {
      const container = document.getElementById('toast-container');
      container.classList.remove('hidden');
      
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      container.appendChild(toast);

      setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease forwards';
        setTimeout(() => toast.remove(), 300);
      }, 4000);
    }

    // Load dropdown options from API
    async function loadFormOptions() {
      try {
        const response = await fetch(API_BASE, {
          headers: {
            'Accept': 'application/json'
          }
        });

        if (!response.ok) {
          throw new Error('Failed to load form options');
        }

        const data = await response.json();
        console.log('Form data loaded:', data);
        
        // Populate users dropdown from the response
        const userSelect = document.getElementById('userID');
        const roleSelect = document.getElementById('role');
        
        // Get all unique users from the response
        const usersSet = new Map();
        const rolesSet = new Map();
        
        if (data.users && Array.isArray(data.users)) {
          // If response has users array directly
          data.users.forEach(user => {
            if (!usersSet.has(user.id)) {
              usersSet.set(user.id, user);
            }
          });
        }
        
        if (data.roles && Array.isArray(data.roles)) {
          // If response has roles array directly
          data.roles.forEach(role => {
            if (!rolesSet.has(role.id)) {
              rolesSet.set(role.id, role);
            }
          });
        }
        
        // Add users to dropdown
        usersSet.forEach((user) => {
          const option = document.createElement('option');
          option.value = user.id;
          option.textContent = `${user.first_name} ${user.last_name} (${user.email})`;
          userSelect.appendChild(option);
        });
        
        // Add roles to dropdown
        rolesSet.forEach((role) => {
          const option = document.createElement('option');
          option.value = role.id;
          option.textContent = role.name;
          roleSelect.appendChild(option);
        });
        
        console.log(`Loaded ${usersSet.size} users and ${rolesSet.size} roles`);
      } catch (error) {
        console.error('Error loading options:', error);
        showToast('Failed to load form options', 'error');
      }
    }

    // Load current assignments
    async function loadAssignments() {
      const loadingEl = document.getElementById('assignments-loading');
      const errorEl = document.getElementById('assignments-error');
      const wrapperEl = document.getElementById('assignments-wrapper');

      loadingEl.style.display = 'block';
      errorEl.classList.add('hidden');
      wrapperEl.style.display = 'none';

      try {
        const response = await fetch(API_BASE, {
          method: 'GET',
          headers: {
            'Accept': 'application/json'
          }
        });

        if (!response.ok) {
          throw new Error('Failed to load assignments');
        }

        const data = await response.json();
        populateAssignmentsTable(data.users || []);
        wrapperEl.style.display = 'block';
      } catch (error) {
        console.error('Error loading assignments:', error);
        document.getElementById('assignments-error-message').textContent = error.message;
        errorEl.classList.remove('hidden');
      } finally {
        loadingEl.style.display = 'none';
      }
    }

    // Populate assignments table
    function populateAssignmentsTable(assignments) {
      const tbody = document.getElementById('assignments-body');
      tbody.innerHTML = '';

      if (assignments.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #999;">No role assignments found</td></tr>';
        return;
      }

      assignments.forEach(assignment => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${assignment.user_id}</td>
          <td>${assignment.first_name}</td>
          <td>${assignment.last_name}</td>
          <td>${assignment.email}</td>
          <td><strong>${assignment.role_name}</strong></td>
          <td>
            <span style="display: inline-block; padding: 4px 8px; border-radius: 4px; background-color: ${assignment.is_active ? '#d4edda' : '#f8d7da'}; color: ${assignment.is_active ? '#155724' : '#856404'}; font-size: 12px;">
              ${assignment.is_active ? 'Active' : 'Inactive'}
            </span>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    // Handle form submission
    document.getElementById('assign-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const userID = document.getElementById('userID').value;
      const role = document.getElementById('role').value;

      // Clear previous errors
      document.getElementById('userID-error').classList.add('hidden');
      document.getElementById('role-error').classList.add('hidden');

      if (!userID || !role) {
        if (!userID) {
          document.getElementById('userID-error').textContent = 'Please select a user';
          document.getElementById('userID-error').classList.remove('hidden');
        }
        if (!role) {
          document.getElementById('role-error').textContent = 'Please select a role';
          document.getElementById('role-error').classList.remove('hidden');
        }
        return;
      }

      try {
        const response = await fetch(API_BASE, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': CSRF_TOKEN,
            'Accept': 'application/json'
          },
          body: JSON.stringify({
            userID: parseInt(userID),
            role: parseInt(role)
          })
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.errors ? JSON.stringify(data.errors) : data.error || 'Failed to assign role');
        }

        showToast(data.message, 'success');
        document.getElementById('assign-form').reset();
        
        // Reload assignments
        await loadAssignments();
      } catch (error) {
        console.error('Error assigning role:', error);
        showToast(error.message, 'error');
      }
    });

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
      loadFormOptions();
      loadAssignments();
    });
  </script>
</body>
</html>
