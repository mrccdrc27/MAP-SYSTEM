{% extends 'superadmin/base.html' %}

{% block title %}{% if action == 'create' %}Create User{% else %}Edit User{% endif %} - Superuser Admin{% endblock %}

{% block content %}
<div class="page-header">
    <h2>{% if action == 'create' %}Create New User{% else %}Edit User{% endif %}</h2>
    <a href="{% url 'superadmin-user-masterlist' %}" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Back to List
    </a>
</div>

{% if error %}
<div class="alert alert-danger">
    <i class="fas fa-exclamation-circle"></i>
    {{ error }}
</div>
{% endif %}

<div class="card">
    <form id="user-form" onsubmit="return submitForm(event)">
        {% csrf_token %}
        
        <h3 class="card-title" style="margin-bottom: 20px;">
            <i class="fas fa-user"></i> Account Information
        </h3>
        
        <div class="form-grid">
            <div class="form-group">
                <label class="form-label" for="email">Email Address *</label>
                <input type="email" class="form-control" id="email" name="email" 
                       value="{{ user_obj.email|default:'' }}" 
                       {% if action == 'edit' %}readonly{% endif %}
                       required>
                {% if action == 'edit' %}
                <small style="color: var(--text-muted);">Email cannot be changed after creation.</small>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label class="form-label" for="username">Username</label>
                <input type="text" class="form-control" id="username" name="username" 
                       value="{{ user_obj.username|default:'' }}">
            </div>
            
            <div class="form-group">
                <label class="form-label" for="password">
                    Password {% if action == 'create' %}*{% endif %}
                </label>
                <input type="password" class="form-control" id="password" name="password" 
                       {% if action == 'create' %}required{% endif %}>
                {% if action == 'edit' %}
                <small style="color: var(--text-muted);">Leave blank to keep current password.</small>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label class="form-label" for="company_id">Company ID</label>
                <input type="text" class="form-control" id="company_id" name="company_id" 
                       value="{{ user_obj.company_id|default:'' }}" readonly>
                <small style="color: var(--text-muted);">Auto-generated.</small>
            </div>
        </div>
        
        <hr style="border-color: var(--border-color); margin: 30px 0;">
        
        <h3 class="card-title" style="margin-bottom: 20px;">
            <i class="fas fa-id-card"></i> Personal Information
        </h3>
        
        <div class="form-grid">
            <div class="form-group">
                <label class="form-label" for="first_name">First Name</label>
                <input type="text" class="form-control" id="first_name" name="first_name" 
                       value="{{ user_obj.first_name|default:'' }}">
            </div>
            
            <div class="form-group">
                <label class="form-label" for="middle_name">Middle Name</label>
                <input type="text" class="form-control" id="middle_name" name="middle_name" 
                       value="{{ user_obj.middle_name|default:'' }}">
            </div>
            
            <div class="form-group">
                <label class="form-label" for="last_name">Last Name</label>
                <input type="text" class="form-control" id="last_name" name="last_name" 
                       value="{{ user_obj.last_name|default:'' }}">
            </div>
            
            <div class="form-group">
                <label class="form-label" for="suffix">Suffix</label>
                <select class="form-control" id="suffix" name="suffix">
                    <option value="">None</option>
                    <option value="Jr." {% if user_obj.suffix == 'Jr.' %}selected{% endif %}>Jr.</option>
                    <option value="Sr." {% if user_obj.suffix == 'Sr.' %}selected{% endif %}>Sr.</option>
                    <option value="II" {% if user_obj.suffix == 'II' %}selected{% endif %}>II</option>
                    <option value="III" {% if user_obj.suffix == 'III' %}selected{% endif %}>III</option>
                    <option value="IV" {% if user_obj.suffix == 'IV' %}selected{% endif %}>IV</option>
                    <option value="V" {% if user_obj.suffix == 'V' %}selected{% endif %}>V</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="phone_number">Phone Number</label>
                <input type="tel" class="form-control" id="phone_number" name="phone_number" 
                       value="{{ user_obj.phone_number|default:'' }}"
                       placeholder="+15551234567">
                <small style="color: var(--text-muted);">E.164 format (e.g., +15551234567)</small>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="department">Department</label>
                <select class="form-control" id="department" name="department">
                    <option value="">Select Department</option>
                    {% for dept in departments %}
                    <option value="{{ dept }}" {% if user_obj.department == dept %}selected{% endif %}>{{ dept }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        
        <hr style="border-color: var(--border-color); margin: 30px 0;">
        
        <h3 class="card-title" style="margin-bottom: 20px;">
            <i class="fas fa-cog"></i> Status & Permissions
        </h3>
        
        <div class="form-grid">
            <div class="form-group">
                <label class="form-label" for="status">Status</label>
                <select class="form-control" id="status" name="status">
                    {% for stat in status_choices %}
                    <option value="{{ stat }}" {% if user_obj.status == stat %}selected{% endif %}>{{ stat }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Account Flags</label>
                <div style="display: flex; flex-direction: column; gap: 12px; padding-top: 5px;">
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="is_active" name="is_active" 
                               {% if user_obj.is_active or action == 'create' %}checked{% endif %}>
                        <label for="is_active">Is Active (can login)</label>
                    </div>
                    
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="is_staff" name="is_staff" 
                               {% if user_obj.is_staff %}checked{% endif %}>
                        <label for="is_staff">Is Staff (admin access)</label>
                    </div>
                    
                    {% if user_obj.id != request.user.id %}
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="is_superuser" name="is_superuser" 
                               {% if user_obj.is_superuser %}checked{% endif %}>
                        <label for="is_superuser">Is Superuser (all permissions)</label>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        {% if action == 'edit' and user_obj.is_locked %}
        <hr style="border-color: var(--border-color); margin: 30px 0;">
        
        <div class="alert alert-warning">
            <i class="fas fa-lock"></i>
            <div>
                <strong>Account Locked</strong>
                <p style="margin: 5px 0 0;">This account is locked due to failed login attempts.</p>
            </div>
        </div>
        
        <div class="checkbox-wrapper" style="margin-top: 15px;">
            <input type="checkbox" id="unlock" name="unlock">
            <label for="unlock">Unlock this account</label>
        </div>
        {% endif %}
        
        <hr style="border-color: var(--border-color); margin: 30px 0;">
        
        <div class="btn-group" style="justify-content: flex-end;">
            <a href="{% url 'superadmin-user-masterlist' %}" class="btn btn-secondary">
                <i class="fas fa-times"></i> Cancel
            </a>
            <button type="submit" class="btn btn-primary" id="submit-btn">
                <i class="fas fa-save"></i> {% if action == 'create' %}Create User{% else %}Save Changes{% endif %}
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // CSRF token for API calls
    function getCsrfToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]')?.value;
    }
    
    async function submitForm(event) {
        event.preventDefault();
        
        const form = document.getElementById('user-form');
        const submitBtn = document.getElementById('submit-btn');
        const action = '{{ action }}';
        const userId = '{{ user_obj.id|default:"" }}';
        
        // Disable submit button
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        
        // Collect form data
        const formData = {
            email: form.email.value,
            username: form.username.value || null,
            first_name: form.first_name.value,
            middle_name: form.middle_name.value || null,
            last_name: form.last_name.value,
            suffix: form.suffix.value || null,
            phone_number: form.phone_number.value || null,
            department: form.department.value || null,
            status: form.status.value,
            is_active: form.is_active.checked,
            is_staff: form.is_staff.checked,
        };
        
        // Add password only if provided
        if (form.password.value) {
            formData.password = form.password.value;
        }
        
        // Add superuser flag if checkbox exists
        const superuserCheckbox = document.getElementById('is_superuser');
        if (superuserCheckbox) {
            formData.is_superuser = superuserCheckbox.checked;
        }
        
        // Add unlock flag if checkbox exists and checked
        const unlockCheckbox = document.getElementById('unlock');
        if (unlockCheckbox && unlockCheckbox.checked) {
            formData.unlock = true;
        }
        
        try {
            let url, method;
            
            if (action === 'create') {
                url = '{% url "superadmin-api-user-create" %}';
                method = 'POST';
            } else {
                url = `/superadmin/api/users/${userId}/`;
                method = 'PUT';
            }
            
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify(formData)
            });
            
            const data = await response.json();
            
            if (response.ok) {
                alert(data.message);
                window.location.href = '{% url "superadmin-user-masterlist" %}';
            } else {
                alert('Error: ' + (data.error || 'Operation failed'));
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-save"></i> {% if action == "create" %}Create User{% else %}Save Changes{% endif %}';
            }
        } catch (error) {
            alert('Network error: ' + error.message);
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-save"></i> {% if action == "create" %}Create User{% else %}Save Changes{% endif %}';
        }
        
        return false;
    }
</script>
{% endblock %}
