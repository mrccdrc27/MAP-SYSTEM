# add pgadmin somewhere
# docker-compose build
# docker-compose up -d
# lessen the postgresql to one, provision multiple dbs in the same instance
# none of the following env's would be used if there is already an .env file in the respective service directory

services:
  # RabbitMQ for message queueing - No sleep
  rabbitmq:
    image: rabbitmq:3-management
    container_name: rabbitmq
    ports:
      - "5672:5672"       # AMQP protocol
      - "15672:15672"     # Management UI
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: admin
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq

  # Single PostgreSQL database instance - No sleep
  db:
    image: postgres:15
    container_name: postgres_db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgrespass
      POSTGRES_DB: postgres
    ports:
      - "5433:5432"  # Changed the host port to 5433
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./db-init:/docker-entrypoint-initdb.d

  # Worker derived from workflow-api - 20 seconds sleep
  workflow-worker:
    build:
      context: ../workflow_api
      dockerfile: Dockerfile
    environment:
      DJANGO_CELERY_BROKER_URL: "amqp://admin:admin@rabbitmq:5672/"
      DATABASE_URL: "postgres://postgres:postgrespass@db:5432/workflowmanagement"
      # the important thing in naming the service is to not use underscores (_)
      # auth-service is different from auth_service
      DJANGO_AUTH_SERVICE: "http://auth-service:8000"
      DJANGO_ENV: "production"
      C_FORCE_ROOT: "false"
    volumes:
      - media_files:/app/media
    command: >
      sh -c "sleep 20 && 
             celery -A workflow_api worker --pool=solo --loglevel=info -Q role_send-default,TICKET_TASKS_PRODUCTION"
    depends_on:
      - rabbitmq
      - db

  # Ticket service - 10 seconds sleep
  ticket-service:
    build:
      context: ../ticket_service
      dockerfile: Dockerfile
    environment:
      BASE_URL: "http://ticket-service:7000"
      CELERY_BROKER_URL: "amqp://admin:admin@rabbitmq:5672/"
      DATABASE_URL: "postgres://postgres:postgrespass@db:5432/ticketmanagement"
      CELERY_TASK_DEFAULT_QUEUE: "TICKET_TASKS_PRODUCTION"
    ports:
      - "8004:7000"
    volumes:
      - media_files:/app/media
    depends_on:
      - rabbitmq
      - db
    command: sh -c "sleep 10 && ./start.sh"

  # Workflow API service - 10 seconds sleep
  workflow-api:
    build:
      context: ../workflow_api
      dockerfile: Dockerfile
    environment:
      DJANGO_CELERY_BROKER_URL: "amqp://admin:admin@rabbitmq:5672/"
      DATABASE_URL: "postgres://postgres:postgrespass@db:5432/workflowmanagement"
      DJANGO_ENV: "production"
      DJANGO_AUTH_SERVICE: "http://auth-service:8000"
      DJANGO_USER_SERVICE: "http://auth-service:8000"
      DJANGO_NOTIFICATION_QUEUE: notification-queue-default
      DJANGO_TICKET_STATUS_QUEUE: ticket_status-default
    ports:
      - "8002:8000"
    depends_on:
      - rabbitmq
      - db
    command: sh -c "sleep 10 && ./start.sh"

  # Auth service - 10 seconds sleep
  auth-service:
    build:
      context: ../auth
      dockerfile: Dockerfile
    environment:
      # DJANGO_FRONTEND_URL: http://localhost:1000/
      DJANGO_CELERY_BROKER_URL: "amqp://admin:admin@rabbitmq:5672/"
      DATABASE_URL: "postgres://postgres:postgrespass@db:5432/authservice"
      DJANGO_DEBUG: "True"
      DJANGO_ALLOWED_HOSTS: "*"
      # DJANGO_ENV: "production"
      SECRET_KEY: "your-auth-service-secret-key-here"
      EMAIL_HOST: smtp.gmail.com
      EMAIL_PORT: 587
      EMAIL_HOST_USER: mayuga.marccedricc@gmail.com
      EMAIL_HOST_PASSWORD: qlit lmbg siip vvkh
      EMAIL_USE_TLS: True
      DEFAULT_FROM_EMAIL: gensystest@mail.com
      ALLOWED_HOSTS: "*"
    ports:
      - "8003:8000"
    depends_on:
      - rabbitmq
      - db
    command: sh -c "sleep 10 && ./entrypoint.sh"
    
  # Messaging service - 10 seconds sleep
  messaging-service:
    build:
      context: ../messaging
      dockerfile: Dockerfile
    environment:
      DATABASE_URL: "postgres://postgres:postgrespass@db:5432/messagingservice"
      DJANGO_DEBUG: "True"
      DJANGO_ALLOWED_HOSTS: "*"
      SECRET_KEY: "your-messaging-service-secret-key-here"
      ALLOWED_HOSTS: "*"
    ports:
      - "8005:8001"
    depends_on:
      - db
    command: sh -c "sleep 10 && ./entrypoint.sh"
    
  # Notification service - 10 seconds sleep
  notification-service:
    build:
      context: ../notification_service
      dockerfile: Dockerfile
    environment:
      # DATABASE_URL: "postgres://postgres:postgrespass@db:5432/notificationservice"
      CELERY_BROKER_URL: "amqp://admin:admin@rabbitmq:5672/"
      NOTIFICATION_QUEUE: "notification-queue"
      INAPP_NOTIFICATION_QUEUE: "inapp-notification-queue"
      DJANGO_ALLOWED_HOSTS: "*"
      NOTIFICATION_API_KEYS: "demo-api-key-123,test-api-key-456,your-secure-api-key"
      JWT_SHARED_SECRET_KEY: "your-auth-service-secret-key-here"
      ALLOWED_HOSTS: "*"
      AUTH_SERVICE_URL: "http://auth-service:8000"
      EMAIL_BACKEND: "django.core.mail.backends.console.EmailBackend"
      SECRET_KEY: "your-auth-service-secret-key-here"
      DJANGO_ENV: "production"
    ports:
      - "8006:8001"
    depends_on:
      - rabbitmq
      - db
    command: sh -c "sleep 10 && ./entrypoint.sh"
    
  # Notification worker - 15 seconds sleep
  notification-worker:
    build:
      context: ../notification_service
      dockerfile: Dockerfile
    environment:
      DATABASE_URL: "postgres://postgres:postgrespass@db:5432/notificationservice"
      DJANGO_ENV: "production"
      CELERY_BROKER_URL: "amqp://admin:admin@rabbitmq:5672/"
    depends_on:
      - rabbitmq
      - db
      - notification-service
    command: >
      sh -c "sleep 5 && 
             celery -A notification_service worker --loglevel=info -Q notification-queue,inapp-notification-queue"

  # frontend:
  # frontend:
  #   build:
  #     context: ../frontend
  #     dockerfile: Dockerfile
  #   environment:
  #     # the following env var don't get used, the one's from the .env file in the frontend directory get used instead
  #     VITE_AUTH_URL: http://auth-service:8000
  #     VITE_WORKFLOW_API: http://workflow-api:8000/workflow
  #     VITE_BACKEND_API: http://workflow-api:8000/
  #   ports:
  #     - "1000:1000"
  #   depends_on:
  #     - ticket-service
  #     - workflow-api

volumes:
  rabbitmq_data:
  postgres_data:
  media_files: